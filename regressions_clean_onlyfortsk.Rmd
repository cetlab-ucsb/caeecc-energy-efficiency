---
title: "Regressions (Clean)"
author: "Michelle Le"
date: "6/20/2021"
output: html_document
---
##Load data and libraries 

```{r, load packages}
library(readr)
library(data.table)
library(dplyr)
library(ggplot2)
library(tidyverse)
library(psych) #for pair.panels()
library(car) #for the qqPlot function
library(nlme) #for fitting mixed effects models (linear models with random effects)
library(fitdistrplus)
library(stargazer) #to make regression tables, learn more at https://cran.r-project.org/web/packages/stargazer/vignettes/stargazer.pdf
library(pscl)
library(splines)
```

```{r, Start}
#read in data for K-12 EE programs 
K12 <- read.csv("k12_counties_3.csv")
counties <- read.csv("counties_3.csv")
cities <- read.csv("cities_3.csv")
```

##Important 
Things to look for: Small AIC, Large R^2, p-value should be < 0.05 to be significant 

Every group is treated differently, but there is some similarity in the workflow and how regressions were set up. Chunks in each section follows as so:

1. Spatial code (only for K12 and counties) 
2. Perform necessary transformations of variables to use for later (log-transformation, rounding, etc.)
3. Subset dataset to groups we want to analyze (those who participated, those who didn't, quantiles, omitting NAs (city-specific))
4. Identify outliers through the use of Cook's distance (using the 4/n cutoff) and take them out (K12_x, counties_x, cities_x)
5. Observe which variables have a high correlation coefficient through scatterplot matrix (recommended by Tatum to take out variables that have a value > 0.7)
6. Visualize distributions of y-variables (budget, kWh) and their transformed counterparts (ln_budget,budgetpercapita, ln_budgetpercapita, etc.) to determine who is normal, who is not, and what regressions are appropriate (normal or poisson)
7. Use StepAIC to take into account which variables are picked by this method 
8. Perform poisson regressions
9. Perform normal regressions for budget
10. Perform normal regressions for kWh
11. Create regression results table by compiling all regressions together using stargazer package
12. T-tests on full dataset (only for K12)

##K12

```{r, K12 transformations}
#log-transform budget and kWh
K12$ln_budget <- log(K12$budget + 1)
K12$ln_kWh <- log(K12$kWh + 1)
K12$ln_enrollment <- log(K12$enrollment + 1)

#round budget and kWh
K12$roundedbudget <- round(K12$budget, 0)
K12$roundedkWh <- round(K12$kWh, 0)

#add a binary indicator
K12$ybudget <- ifelse(K12$budget>0, 1, 0)
K12$ykWh <- ifelse(K12$kWh>0, 1, 0)

#per student
K12$budgetperstudent <- K12$budget/K12$enrollment
K12$lcffperstudent <- K12$lcff/K12$enrollment
K12$kWhperstudent <- K12$kWh/K12$enrollment
K12$incomepercapita <- K12$income/K12$population

K12$ln_budgetperstudent <- log(K12$budgetperstudent + 1)
K12$ln_lcffperstudent <- log(K12$lcffperstudent + 1)
K12$ln_kWhperstudent <- log(K12$kWhperstudent + 1)

K12$roundedlnbudgetper <- round(K12$ln_budgetperstudent, 0)
K12$roundedlnkWhper <- round(K12$ln_kWhperstudent, 0)

K12$roundedlnbudget <- round(K12$ln_budget, 0)
K12$roundedlnkWh <- round(K12$ln_kWh, 0)

K12$roundedbudgetper <- round(K12$budgetperstudent, 0)
K12$roundedkWhper <- round(K12$kWhperstudent, 0)
```

```{r, K12 subsetting}
#only considering the counties that did participate 
K12_subset <- subset(K12, budget > 0)
#only considering the counties that did not participate 
K12_no = subset(K12, budget = 0)

#quantiles
quantile(K12$ln_enrollment)
#split into groups based ln_enrollment 
K12_1 <- subset(K12, ln_enrollment <= 8.707647)
K12_2 <- subset(K12, ln_enrollment > 8.707647 & ln_enrollment <= 10.336342)
K12_3 <- subset(K12, ln_enrollment > 10.336342 & ln_enrollment <= 11.532680)
K12_4 <- subset(K12, ln_enrollment > 11.532680)

```

```{r, K12 subsetting outliers}
#outliers
#boxplot(K12_subset$budget)

test.K12 <- glm(budget ~ 1, data = K12_subset)
K12CDs <- cooks.distance(test.K12)

# Plot the Cook's Distance using the traditional 4/n criterion
K12_sample_size <- nrow(K12_subset)
plot(K12CDs, pch="*", cex=2, main="Influential Obs by Cooks distance")  # plot cook's distance
abline(h = 4/K12_sample_size, col="red")  # add cutoff line
text(x=1:length(K12CDs)+1, y=K12CDs, labels=ifelse(K12CDs>4/K12_sample_size, names(K12CDs),""), col="red")  # add labels

#19 (LA) is an outlier
```

```{r, subsetting outliers}
#taking out the outliers 
K12_x <- K12_subset[!(K12_subset$county %in% c("LOS ANGELES")),] 
```

##Counties

```{r, counties transformations}
#log-transform 
counties$ln_kWh <- log(counties$kWh + 1)
counties$ln_rev <- log(counties$revenue)
counties$ln_population <- log(counties$population)

#round budget and kWh
counties$roundedbudget <- round(counties$budget, 0)
counties$roundedkWh <- round(counties$kWh, 0)

#add a binary indicator
counties$ybudget <- ifelse(counties$budget>0, 1, 0)
counties$ykWh <- ifelse(counties$kWh>0, 1, 0)

#per person
counties$budgetpercapita <- counties$budget/counties$population
counties$revpercapita <- counties$revenue/counties$population
counties$kWhpercapita <- counties$kWh/counties$population

counties$ln_budgetpercapita <- log(counties$budgetpercapita + 1)
counties$ln_revpercapita <- log(counties$revpercapita + 1)
counties$ln_kWhpercapita <- log(counties$kWhpercapita + 1)

#round 
counties$roundedbudgetper <- round(counties$budgetpercapita, 0)
counties$roundedkWhper <- round(counties$kWhpercapita, 0)
```

```{r, counties subsetting}

#only considering the counties that did participate 
counties_subset <- subset(counties, budget > 0)
#only considering the counties that did not participate 
counties_no = subset(counties, budget = 0)

#quantiles
quantile(counties$ln_population)
#split into groups based ln_enrollment 
counties_1 <- subset(counties, population <= 10.768725)
counties_2 <- subset(counties, population > 10.768725 & population <= 12.125893)
counties_3 <- subset(counties, population > 12.125893 & population <= 13.43974)
counties_4 <- subset(counties, population > 13.43974)
```

```{r, counties subsetting outliers}
#outliers
#boxplot(counties_subset$budget)

test.counties <- glm(budget ~ 1, data = counties_subset)
countiesCDs <- cooks.distance(test.counties)

# Plot the Cook's Distance using the traditional 4/n criterion
counties_sample_size <- nrow(counties_subset)
plot(countiesCDs, pch="*", cex=2, main="Influential Obs by Cooks distance")  # plot cook's distance
abline(h = 4/counties_sample_size, col="red")  # add cutoff line
text(x=1:length(countiesCDs)+1, y=countiesCDs, labels=ifelse(countiesCDs>4/counties_sample_size, names(countiesCDs),""), col="red")  # add labels

#19 (LA), #37 (SD), and #38 (SF) are outliers
```

```{r, counties subsetting outliers}
#taking out the outliers 
counties_x <- counties_subset[!(counties_subset$county %in% c("LOS ANGELES", "SAN DIEGO", "SAN FRANCISCO")),]
```

##Cities

```{r, cities transformations}
#log-transform 
cities$ln_budget <- log(cities$budget + 1)
cities$ln_kWh <- log(cities$kWh + 1)
cities$ln_rev <- log(cities$revenue)

#round budget and kWh
cities$roundedbudget <- round(cities$budget, 0)
cities$roundedkWh <- round(cities$kWh, 0)

#add a binary indicator
cities$ybudget <- ifelse(cities$budget>0, 1, 0)
cities$ykWh <- ifelse(cities$kWh>0, 1, 0)

#per student
cities$budgetpercapita <- cities$budget/cities$population
cities$revpercapita <- cities$revenue/cities$population
cities$kWhpercapita <- cities$kWh/cities$population

cities$ln_budgetpercapita <- log(cities$budgetpercapita)
cities$ln_revpercapita <- log(cities$revpercapita)
cities$ln_kWhpercapita <- log(cities$kWhpercapita + 1)

#round budget and kWh
cities$roundedbudgetper <- round(cities$budgetpercapita, 0)
cities$roundedkWhper <- round(cities$kWhpercapita, 0)
```

```{r, city subsetting}
#get rid of cities with NAs for tax revenue
cities_na <- na.omit(cities)
```

```{r, cities subsetting outliers}
#outliers
#boxplot(cities_na$budget)

test.cities <- glm(budget ~ 1, data = cities_na)
citiesCDs <- cooks.distance(test.cities)

# Plot the Cook's Distance using the traditional 4/n criterion
cities_sample_size <- nrow(cities_na)
plot(citiesCDs, pch="*", cex=2, main="Influential Obs by Cooks distance")  # plot cook's distance
abline(h = 4/cities_sample_size, col="red")  # add cutoff line
text(x=1:length(citiesCDs)+1, y=citiesCDs, labels=ifelse(citiesCDs>4/cities_sample_size, names(citiesCDs),""), col="red")  # add labels

#326 (SAN FRANCISCO) and 325 (SAN DIEGO) are outliers and 201 (LA) and 26 (BAKERSFIELD)
```

```{r, cities subsetting}
#taking out the outliers 
cities_x <- cities_na[!(cities_na$city %in% c("SAN DIEGO", "SAN FRANCISCO", "BAKERSFIELD", "LOS ANGELES")),] 
```

## figure 5 - make plotting dataframe, theme, p-val and r2 grob, color palette

```{r}

# plotting dataframe
co <- counties_x[,c("budget","ln_budgetpercapita",
                  "irr", "revpercapita",
                  "population", "obf")]
co$Level <- "Local government\n(county analysis)"
ci <- cities_x[,c("budget", "ln_budgetpercapita",
                  "revenue", "obf",
                  "ruca")]
ci$Level <- "Local government\n(city analysis)"
k <- K12_x[,c("budget","ln_budgetperstudent",
              "perc_eligible_frpm", "lcff",
              "perc_title1","dac")]
k$Level <- "K-12 schools\n(county analysis)"

dat <- merge(co,ci,
             by=c("budget","ln_budgetpercapita",
                  "Level"),
             all=T)
dat <- merge(dat, k,
             by=c("budget","Level"),
             all=T)

dat$ln_budget <- log(dat$budget+1)
names(dat)[c(5,7:9)] <- c("revpercap_co","obf_co",
                          "rev_ci","obf_ci")

# universal theme
theme_ups <- function(){ 
    font <- "Arial"
    theme_bw() %+replace%    #replace elements we want to change
    theme(
      #text elements
      axis.title = element_text(             #axis titles
                   family = font,            #font family
                   size = 12),               #font size
      
      axis.text = element_text(              #axis text
                   family = font,            #axis famuly
                   size = 9)                 #font size
    )
}

# p-val and rho grob
corr.co.b.irr <- cor.test(dat$ln_budget,dat$irr)
corr.co.b.revpc <- cor.test(dat$ln_budget,dat$revpercap_co)
corr.co.bpc.pop <- cor.test(dat$ln_budgetpercapita,dat$population)
corr.co.bpc.obf <- cor.test(dat$ln_budgetpercapita,dat$obf_co)
corr.ci.b.rev <- cor.test(dat$ln_budget,dat$rev_ci)
corr.ci.b.obf <- cor.test(dat$ln_budget,dat$obf_ci)
corr.ci.bpc.ruca <- cor.test(dat$ln_budgetpercapita,dat$ruca)
corr.ci.bpc.obf <- cor.test(dat$ln_budgetpercapita,dat$obf_ci)
corr.k.b.frmp <- cor.test(dat$ln_budget,dat$perc_eligible_frpm)
corr.k.b.lcff <- cor.test(dat$ln_budget,dat$lcff)
corr.k.bps.t1 <- cor.test(dat$ln_budgetperstudent,dat$perc_title1)
corr.k.bps.dac <- cor.test(dat$ln_budgetperstudent,dat$dac)
corrs <- list(corr.co.b.irr,corr.co.b.revpc,corr.co.bpc.pop,corr.co.bpc.obf,
              corr.ci.b.rev,corr.ci.b.obf,corr.ci.bpc.ruca,corr.ci.bpc.obf,
              corr.k.b.frmp,corr.k.b.lcff,corr.k.bps.t1,corr.k.bps.dac)
pval <- c()
rho <- c()
for(i in 1:length(corrs)){
  pval[i] <- corrs[[i]]$p.value
  if(pval[i]>0.1){star <- ""}
  else if(pval[i]>0.05){star <- "*"}
  else if(pval[i]>0.01){star <- "**"}
  else{star <- "***"}
  rho[i] <- paste0("r = ", round(corrs[[i]]$estimate,2), star)
}

library(grid)
rhogrob <- list()
for(i in 1:length(rho)){
  rhogrob[[i]] <- grobTree(textGrob(rho[i], hjust=1, vjust=1, x=0.95,  y=0.95,
                          gp=gpar(col="black", fontsize=10,fontface="bold")))
}

# colors!
upscolors <- c('#bcdb51', '#59a98c','#69719c')

```

## figure 5 - make the figure

```{r}

#county
co.bu.irr <- ggplot(dat, aes(y=ln_budget, x=irr, color=Level))+
  geom_point(alpha=0.8)+
  geom_smooth(method="lm", color="black")+
  labs(x="Rurality\n(Index of Relative Rurality)", y="\nLog of Budget")+
  scale_color_manual(values=upscolors)+
  annotation_custom(rhogrob[[1]])+
  theme_ups()
co.bu.rev <- ggplot(dat, aes(y=ln_budget, x=revpercap_co, color=Level))+
  geom_point(alpha=0.8)+
  geom_smooth(method="lm", color="black")+
  labs(x="Revenue per Capita\n", y="\nLog of Budget")+
  scale_color_manual(values=upscolors)+
  annotation_custom(rhogrob[[2]])+
  theme_ups()
co.bupc.pop <- ggplot(dat, aes(y=ln_budgetpercapita, x=population, color=Level))+
  geom_point(alpha=0.8)+
  geom_smooth(method="lm", color="black")+
  labs(x="Population\n", y="Log of Budget\nper Capita")+
  scale_color_manual(values=upscolors)+
  annotation_custom(rhogrob[[3]])+
  theme_ups()
co.bupc.obf <- ggplot(dat, aes(y=ln_budgetpercapita, x=obf_co, color=Level))+
  geom_point(alpha=0.8)+
  geom_smooth(method="lm", color="black")+
  labs(x="Percent of\nOn-bill Financing", y="Log of Budget\nper Capita")+
  scale_color_manual(values=upscolors)+
  annotation_custom(rhogrob[[4]])+
  theme_ups()

#city
ci.bu.rev <- ggplot(dat, aes(y=ln_budget, x=rev_ci, color=Level))+
  geom_point(alpha=0.8)+
  geom_smooth(method="lm", color="black")+
  labs(x="Total Revenue\n", y="\nLog of Budget")+
  scale_color_manual(values=upscolors)+
  annotation_custom(rhogrob[[5]])+
  theme_ups()
ci.bu.obf <- ggplot(dat, aes(y=ln_budget, x=obf_ci, color=Level))+
  geom_point(alpha=0.8)+
  geom_smooth(method="lm", color="black")+
  labs(x="Percent of\nOn-bill Financing", y="\nLog of Budget")+
  scale_color_manual(values=upscolors)+
  annotation_custom(rhogrob[[6]])+
  theme_ups()
ci.bupc.ruca <- ggplot(dat, aes(y=ln_budgetpercapita, x=ruca, color=Level))+
  geom_point(alpha=0.8)+
  geom_smooth(method="lm", color="black")+
  labs(x="Rurality\n(Rural Urban Commuting Area)", y="Log of Budget\nper Capita")+
  scale_color_manual(values=upscolors)+
  annotation_custom(rhogrob[[7]])+
  theme_ups()
ci.bupc.obf <- ggplot(dat, aes(y=ln_budgetpercapita, x=obf_ci, color=Level))+
  geom_point(alpha=0.8)+
  geom_smooth(method="lm", color="black")+
  labs(x="Percent of\nOn-bill Financing", y="Log of Budget\nper Capita")+
  scale_color_manual(values=upscolors)+
  annotation_custom(rhogrob[[8]])+
  theme_ups()

#k12
k.bu.frpm <- ggplot(dat, aes(y=ln_budget, x=perc_eligible_frpm, color=Level))+
  geom_point(alpha=0.8)+
  geom_smooth(method="lm", color="black")+
  labs(x="Percent of Students Eligible\nfor Free and Reduced Lunch", y="\nLog of Budget")+
  scale_color_manual(values=upscolors)+
  annotation_custom(rhogrob[[9]])+
  theme_ups()
k.bu.lcff <- ggplot(dat, aes(y=ln_budget, x=lcff, color=Level))+
  geom_point(alpha=0.8)+
  geom_smooth(method="lm", color="black")+
  labs(x="Local Control\nFunding Formula", y="\nLog of Budget")+
  scale_color_manual(values=upscolors)+
  annotation_custom(rhogrob[[10]])+
  theme_ups()
k.bupc.t1 <- ggplot(dat, aes(y=ln_budgetperstudent, x=perc_title1, color=Level))+
  geom_point(alpha=0.8)+
  geom_smooth(method="lm", color="black")+
  labs(x="Percent of\nTitle 1 Schools", y="Log of Budget\nper Student")+
  scale_color_manual(values=upscolors)+
  annotation_custom(rhogrob[[11]])+
  theme_ups()
k.bupc.dac <- ggplot(dat, aes(y=ln_budgetperstudent, x=dac, color=Level))+
  geom_point(alpha=0.8)+
  geom_smooth(method="lm", color="black")+
  labs(x="Disadvantaged\nCommunity Proportion (DAC)", y="Log of Budget\nper Student")+
  scale_color_manual(values=upscolors)+
  annotation_custom(rhogrob[[12]])+
  theme_ups()

library(ggpubr)

co.b <- ggarrange(co.bu.irr, co.bu.rev, heights=1, legend="none", align="v", nrow=2)
co.bpc <- ggarrange(co.bupc.pop, co.bupc.obf, heights=1, legend="none", align="v", nrow=2)
co.b <- annotate_figure(co.b, 
                        left=text_grob("Budget\n\n", face="bold", rot=90, just="center", size=14))
co.bpc <- annotate_figure(co.bpc, 
                          left=text_grob("Budget per capita\n\n", face="bold", rot=90, just="center", size=14))

co <- ggarrange(co.b, co.bpc, heights=1, legend="none", align="v", nrow=2)
co <- annotate_figure(co, 
                top=text_grob("Local government\n(county analysis)\n", face="bold", hjust=.2, size=14))

ci <- ggarrange(ci.bu.rev, ci.bu.obf, ci.bupc.ruca, ci.bupc.obf, heights=1, legend="none", align="v", nrow=4)
ci <- annotate_figure(ci, 
                top=text_grob("Local government\n(city analysis)\n", face="bold", hjust=.4, size=14),
                left="\n")

k <- ggarrange(k.bu.frpm, k.bu.lcff, k.bupc.t1, k.bupc.dac, heights=1, legend="none", align="v", nrow=4)
k <- annotate_figure(k,
                     top=text_grob("K-12 schools\n(county analysis)\n", face="bold", hjust=.4, size=14),
                     left="\n")

fig5 <- ggarrange(co, ci, k, ncol = 3, widths = 1, legend = "none", align = "h") +
  annotation_custom(grid.polygon(x = c(.07, .34, .39, .67, .72, 1),
                                 y = c(.93, .93, .93, .93, .93, .93),
                                 id = c(1, 1, 2, 2, 3, 3),
                                 gp = gpar(lwd = 2))) +
  annotation_custom(grid.polygon(x = c(.03, .03, .03, .03),
                                 y = c(.04, .41, .5, .87),
                                 id = c(1, 1, 2, 2),
                                 gp = gpar(lwd = 2)))


ggsave("fig5.jpg", width=1113*3.2, height=932*3.2, dpi=320, units="px")

```











