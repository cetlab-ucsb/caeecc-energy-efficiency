---
title: "Regressions (Clean)"
author: "Michelle Le" "Sydney Litvin" "Atherv Gole" "Audrey Meiman" "Austin Covey" "Nathaniel Villa" "Measrainsey Meng" "Tatum Katz" "Ranjit Deshmukh"
date: "5/7/2024"
output: html_document
---

##Load data and libraries 

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
# knitr::opts_knit$set(root.dir = '~/Documents/github/caeecc-energy-efficiency/data/')
knitr::opts_knit$set(root.dir = './data/')
```

```{r, load packages}
library(readr)
library(data.table)
library(dplyr)
library(ggplot2)
library(ggrepel)
library(tidyverse)
library(psych) #for pair.panels()
library(car) #for the qqPlot function
library(nlme) #for fitting mixed effects models (linear models with random effects)
library(fitdistrplus)
library(stargazer) #to make regression tables, learn more at https://cran.r-project.org/web/packages/stargazer/vignettes/stargazer.pdf
library(pscl)
library(splines)
#for spatial purposes 
library(sf)
library(tigris)
library(maps)
library(tmap)
library(USAboundaries)
library(maptools)
library(stringr)
library(viridis)
library(bit64)
library(gridExtra)
library(grid)
library(lattice)
library(GISTools)
library(yarrr)
```

```{r, cite packages}
citation("readr")
citation("data.table")
citation("dplyr")
citation("ggplot2")
citation("tidyverse")
citation("psych")
citation("car") 
citation("nlme") 
citation("fitdistrplus")
citation("stargazer") 
#for spatial purposes 
citation("sf")
citation("tigris")
citation("maps")
citation("tmap")
citation("USAboundaries")
citation("maptools")
citation("stringr")
citation("viridis")
citation("bit64")
citation("gridExtra")
citation("grid")
citation("lattice")
citation("GISTools")
citation("yarrr")
```

```{r, Start}
#read in data for K-12 EE programs 
K12 <- read.csv("k12_counties_3.csv")
counties <- read.csv("counties_3.csv")
cities <- read.csv("cities_3.csv")
output_path = "/Volumes/GoogleDrive/Shared drives/CETlab/Projects/2020_CAEECC_Public_Sector_Underserved/Journal paper"
exclude_outliers = "no" # "yes" or "no" 
```

##Important 
Things to look for: Small AIC, Large R^2, p-value should be < 0.05 to be significant 

Every group is treated differently, but there is some similarity in the workflow and how regressions were set up. Chunks in each section follows as so:

1. Spatial code (only for K12 and counties) 
2. Perform necessary transformations of variables to use for later (log-transformation, rounding, etc.)
3. Subset dataset to groups we want to analyze (those who participated, those who didn't, quantiles, omitting NAs (city-specific))
4. Identify outliers through the use of Cook's distance (using the 4/n cutoff) and take them out by setting the flag in the previous chunk, which updates K12_subset, counties_subset, cities_subset
5. Observe which variables have a high correlation coefficient through scatterplot matrix (recommended by Tatum to take out variables that have a value > 0.7)
6. Visualize distributions of y-variables (budget, kWh) and their transformed counterparts (ln_budget,budgetpercapita, ln_budgetpercapita, etc.) to determine who is normal, who is not, and what regressions are appropriate (normal or poisson)
7. Use StepAIC to take into account which variables are picked by this method 
8. Perform poisson regressions
9. Perform normal regressions for budget
10. Perform normal regressions for kWh
11. Create regression results table by compiling all regressions together using stargazer package
12. T-tests on full dataset (only for K12)

##Setting up Maps

```{r, Start Here for Spatial}
#make a data frame
all_counties<- map_data("county")
# Lot of observations, this stores geometries of county polygons in an inefficient way (there are 3000 counties in US, but way more observations (storing in point, line way))
#visualize
ggplot(data=all_counties)+
  geom_polygon(aes(x = long, y = lat, fill = region, group = group))+ #if you were using a different coord system you would have to change long and lat
  # fill indicates what we want to colored in, in this case we're doing the states (region=state)
  # group is extremely important. There are lots of point values in this data. Group tells R that all of these points belong in a county
  coord_fixed(1.3)+
  guides(fill = FALSE) #if change to fill = any other color, then you would see the outline of all of the counties (county lines are there even when you put FALSE; however we don't see them at this granularity)
```

```{r, spatial}
#subset to California counties
CA_counties<- subset(x = all_counties, subset = region == "california")
# Check subset with: table(CA_counties$region)
head(CA_counties)

#Read California counties list with their abbreviations
counties_abbr_ca <- read.csv("ca_county_abbr.csv")
# change county names to lower case
counties_abbr_ca$county <- str_to_lower(counties_abbr_ca$county)
head(counties_abbr_ca) #check to see if the county names did change

# merge county abbreviations with CA counties
CA_counties<- left_join(CA_counties, counties_abbr_ca, by = c("subregion"="county"))
CA_counties
```

##K12
```{r, Start}
#read in data for K-12 EE programs 
K12 <- read.csv("k12_counties_3.csv")
```


```{r, K12 transformations}
#log-transform budget, kWh, and enrollment
K12$ln_budget <- log(K12$budget + 1)
K12$ln_kWh <- log(K12$kWh + 1)
K12$ln_enrollment <- log(K12$enrollment + 1)
#round budget and kWh for any poisson attempts
K12$roundedbudget <- round(K12$budget, 0)
K12$roundedkWh <- round(K12$kWh, 0)
#add a binary indicator for any negative binomial attempts 
K12$ybudget <- ifelse(K12$budget>0, 1, 0)
K12$ykWh <- ifelse(K12$kWh>0, 1, 0)
#per student variables
K12$budgetperstudent <- K12$budget/K12$enrollment
K12$lcffperstudent <- K12$lcff/K12$enrollment
K12$kWhperstudent <- K12$kWh/K12$enrollment
K12$incomepercapita <- K12$income/K12$population
K12$ln_budgetperstudent <- log(K12$budgetperstudent + 1)
K12$ln_lcffperstudent <- log(K12$lcffperstudent + 1)
K12$ln_kWhperstudent <- log(K12$kWhperstudent + 1)
K12$roundedlnbudgetper <- round(K12$ln_budgetperstudent, 0)
K12$roundedlnkWhper <- round(K12$ln_kWhperstudent, 0)
K12$roundedlnbudget <- round(K12$ln_budget, 0)
K12$roundedlnkWh <- round(K12$ln_kWh, 0)
K12$roundedbudgetper <- round(K12$budgetperstudent, 0)
K12$roundedkWhper <- round(K12$kWhperstudent, 0)
#scale population and lcff
K12$population_scaled <- K12$population/100000
K12$lcff_scaled <- K12$lcff/100000
K12$lcffperstudent_scaled <- K12$lcffperstudent/100000
K12$income_scaled <- K12$income/100000
```

```{r, K12 subsetting}
#only considering the counties that did participate 
K12_subset <- subset(K12, budget > 0)
#only considering the counties that did not participate 
K12_no = subset(K12, budget = 0)
#quantiles
quantile(K12$ln_enrollment)
#split into groups based ln_enrollment 
K12_1 <- subset(K12, ln_enrollment <= 8.707647)
K12_2 <- subset(K12, ln_enrollment > 8.707647 & ln_enrollment <= 10.336342)
K12_3 <- subset(K12, ln_enrollment > 10.336342 & ln_enrollment <= 11.532680)
K12_4 <- subset(K12, ln_enrollment > 11.532680)
```

```{r, K12 finding outliers}
# budget outliers
test.K12 <- glm(budget ~ 1, data = K12_subset)
K12CDs <- cooks.distance(test.K12)
# Plot the Cook's Distance using the traditional 4/n criterion
K12_sample_size <- nrow(K12_subset)
plot(K12CDs, pch="*", cex=2, main="Influential Obs by Cooks distance,\nbudget")  # plot cook's distance
abline(h = 4/K12_sample_size, col="red")  # add cutoff line
text(x=1:length(K12CDs)+1, y=K12CDs, labels=ifelse(K12CDs>4/K12_sample_size, names(K12CDs),""), col="red")  # add labels
#19 (LA) is an outlier for budget

# budget per student outliers
test.K12.2 <- glm(budgetperstudent ~ 1, data = K12_subset)
K12CDs.2 <- cooks.distance(test.K12.2)
# Plot the Cook's Distance using the traditional 4/n criterion
plot(K12CDs.2, pch="*", cex=2, main="Influential Obs by Cooks distance,\nbudget per student")  # plot cook's distance
abline(h = 4/K12_sample_size, col="red")  # add cutoff line
text(x=1:length(K12CDs.2)+1, y=K12CDs.2, labels=ifelse(K12CDs.2>4/K12_sample_size, names(K12CDs.2),""), col="red")  # add labels
#26 (Mono county) is an oulier for budget per student

#ln_budget outliers
test.K12.3 <- glm(ln_budget ~ 1, data = K12_subset)
K12CDs.3 <- cooks.distance(test.K12.3)
# Plot the Cook's Distance using the traditional 4/n criterion
plot(K12CDs.3, pch="*", cex=2, main="Influential Obs by Cooks distance,\nlog budget")  # plot cook's distance
abline(h = 4/K12_sample_size, col="red")  # add cutoff line
text(x=1:length(K12CDs.3)+1, y=K12CDs.3, labels=ifelse(K12CDs.3>4/K12_sample_size, names(K12CDs.3),""), col="red")  # add labels
#19 (LA) still an outlier

#ln_budget per student outliers
test.K12.4 <- glm(ln_budgetperstudent ~ 1, data = K12_subset)
K12CDs.4 <- cooks.distance(test.K12.4)
# Plot the Cook's Distance using the traditional 4/n criterion
plot(K12CDs.4, pch="*", cex=2, main="Influential Obs by Cooks distance,\nlog budget per student")  # plot cook's distance
abline(h = 4/K12_sample_size, col="red")  # add cutoff line
text(x=1:length(K12CDs.4)+1, y=K12CDs.4, labels=ifelse(K12CDs.4>4/K12_sample_size, names(K12CDs.4),""), col="red")  # add labels
#26, Mono, still an outlier

```

```{r, subsetting outliers}
#taking out the outliers 
print(paste0("Exclude outliers: ", exclude_outliers))
if (exclude_outliers == "yes"){
  K12_subset <- K12_subset[!(K12_subset$county %in% c("LOS ANGELES")),] 
}
print(paste0("K12 sample size: ", nrow(K12_subset)))
```

```{r, K12 scatterplot a}
#this gives us correlation coefficients, distributions, and scatterplots
#scatter plot matrix to check for correlation between all variables and investment/energy savings
plot.K12a <- data.frame(K12$kWh, K12$budget, K12$lcff, K12$enrollment, K12$perc_title1, K12$perc_eligible_frpm, K12$perc_eligible_free, K12$income, K12$irr, K12$dac, K12$ces_score, K12$ces_percentile, K12$obf, K12$resource) #subset out these variables
colnames(plot.K12a)<-c("kWh", "budget", "lcff", "enrollment","p_title1", "p_frpm", "p_free", "income", "IRR","dac", "ces_score", "ces_percentile", "obf","resource") #change column names back to original
pairs.panels(plot.K12a, density = TRUE, cor=TRUE, lm=TRUE) #scatterplot
```
```{r, K12 scatterplot b}
#to see the school count variables
plot.K12b <- data.frame(K12$kWh, K12$budget, K12$lcff, K12$enrollment, K12$no_title1, K12$frmp_count, K12$free_meal_count, K12$income, K12$irr, K12$dac, K12$ces_score, K12$ces_percentile, K12$obf, K12$resource) 
colnames(plot.K12b)<-c("kWh", "budget", "lcff", "enrollment","no_title1", "frpm_count", "free_count", "income", "IRR","dac", "ces_score", "ces_percentile", "obf","resource") 
pairs.panels(plot.K12b, density = TRUE, cor=TRUE, lm=TRUE) 
```
```{r, K12 scatterplot c}
#to see the correlation between school count and percentage variables
plot.K12c <- data.frame(K12$kWh, K12$budget,K12$no_title1, K12$frmp_count, K12$free_meal_count, K12$perc_title1, K12$perc_eligible_frpm, K12$perc_eligible_free) 
colnames(plot.K12c)<-c("kWh", "budget", "p_title1", "p_frpm", "p_free","no_title1", "frpm_count", "free_count") 
pairs.panels(plot.K12c, density = TRUE, cor=TRUE, lm=TRUE) 
```

```{r, K12 scatterplot d}
plot.K12d <- data.frame(K12_subset$kWh, K12_subset$budget, K12_subset$lcff, K12_subset$enrollment, K12_subset$perc_title1, K12_subset$perc_eligible_frpm, K12_subset$perc_eligible_free, K12_subset$income, K12_subset$irr, K12_subset$dac, K12_subset$ces_score, K12_subset$ces_percentile, K12_subset$obf, K12_subset$resource) #subset out these variables
colnames(plot.K12d)<-c("kWh", "budget", "lcff", "enrollment","p_title1", "p_frpm", "p_free", "income", "IRR","dac", "ces_score", "ces_percentile", "obf","resource") #change column names back to original
pairs.panels(plot.K12d, density = TRUE, cor=TRUE, lm=TRUE) #scatterplot
```

```{r, K12 visualize}
#explore our y-variables on full dataset
hist(K12$budget)
hist(K12$kWh)
hist(K12$ln_budget)
hist(K12$ln_kWh)
hist(K12$budgetperstudent)
hist(K12$kWhperstudent)
hist(K12$ln_budgetperstudent)
hist(K12$ln_kWhperstudent)
#explore our y-variables on programs that did participate 
# for removing outliers, set the exclude_outliers flag at the top of the code
hist(K12_subset$budget)
hist(K12_subset$kWh)
hist(K12_subset$lcff)
hist(K12_subset$ln_budget)
hist(K12_subset$ln_kWh)
hist(K12_subset$budgetperstudent)
hist(K12_subset$kWhperstudent)
hist(K12_subset$ln_budgetperstudent)
hist(K12_subset$ln_kWhperstudent)
```

```{r, K12 Step AIC selection, ln_budget}
#testing these variables: lcff_scaled + lcffperstudent_scaled + irr + dac + obf + income + perc_eligible_frpm + perc_title1
#performs stepwise model selection by AIC for budget
stepAIC(lm(ln_budget ~ lcff_scaled + lcffperstudent_scaled + irr + dac + obf + income_scaled + perc_eligible_frpm + perc_title1, data = K12_subset))
```

```{r, K12 Step AIC selection, ln_budgetperstudent}
stepAIC(lm(ln_budgetperstudent ~ lcff_scaled + lcffperstudent_scaled + irr + dac + obf + income_scaled + perc_eligible_frpm + perc_title1, data = K12_subset))
```

```{r, K12 Step AIC selection, ln_kwhperstudenet}
# RD: WE DON'T USE THIS IN OUR PAPER
#performs stepwise model selection by AIC for kWh
stepAIC(lm(ln_kWhperstudent ~ lcff_scaled + lcffperstudent_scaled + irr + dac + obf + income_scaled + perc_eligible_frpm + perc_title1, data = K12_subset))
#ln_kWh ~ lcff_scaled + lcffperstudent_scaled, data = K12_subset
#ln_kWhperstudent ~ lcff_scaled + lcffperstudent_scaled + dac + perc_eligible_frpm + perc_title1, data = K12_subset
```

```{r, eval=FALSE, echo=FALSE, K12 regression, ln_budget and ln_budgetperstudent, no outliers}
#regression from budget, NO OUTLIERS
# WE DON'T USE THIS IN OUR PAPER. WE INCLUDE OUTLIERS. SEE NEXT CHUNK.
# K12.2 <- glm(ln_budget ~  lcff + income + perc_eligible_frpm + perc_title1, data = K12_subset) #Step AIC picks
# summary(K12.2)
K12.2 <- glm(ln_budget ~  lcff_scaled + income_scaled + perc_eligible_frpm + perc_title1, data = K12_subset_no_outliers) #Step AIC picks 
K12.4 <- glm(ln_budget ~ lcff_scaled + lcffperstudent_scaled + irr + dac + obf + income_scaled + perc_eligible_frpm + perc_title1, data = K12_subset_no_outliers) #intuitive picks
K12.6 <- glm( ln_budgetperstudent ~ dac + perc_eligible_frpm + perc_title1, data = K12_subset_no_outliers) #Step AIC picks; important to note this y variable does not meet normal assumptions
summary(K12.6)
K12.6 <- glm( ln_budgetperstudent ~ lcff_scaled + dac + perc_eligible_frpm + perc_title1, data = K12_subset_no_outliers) #Step AIC picks; important to note this y variable does not meet normal assumptions
K12.8 <- glm(ln_budgetperstudent ~ lcff_scaled + lcffperstudent_scaled + irr + dac + obf + income_scaled + perc_eligible_frpm + perc_title1, data = K12_subset_no_outliers) #intuitive picks; important to note this y variable does not meet normal assumptions
stargazer(K12.2, K12.4, K12.6, K12.8, type="text", title="Results", align=TRUE, omit.stat=c("LL","ser","f"), no.space=TRUE)

```

```{r, K12 regression, ln_budget and ln_budgetperstudent}
# regression from budget
K12.2 <- glm(ln_budget ~ lcff_scaled + irr + dac + perc_eligible_frpm + 
    perc_title1, data = K12_subset) #Step AIC picks
K12.4 <- glm(ln_budget ~ lcff_scaled + lcffperstudent_scaled + irr + dac + obf + income_scaled + perc_eligible_frpm + perc_title1, data = K12_subset) #intuitive picks
K12.6 <- glm( ln_budgetperstudent ~ lcff_scaled + dac + perc_eligible_frpm + perc_title1, data = K12_subset) #Step AIC picks; important to note this y variable does not meet normal assumptions
K12.8 <- glm(ln_budgetperstudent ~ lcff_scaled + lcffperstudent_scaled + irr + dac + obf + income_scaled + perc_eligible_frpm + perc_title1, data = K12_subset) 
stargazer(K12.2, K12.4, K12.6, K12.8, type="text", title="Results", align=TRUE, omit.stat=c("LL","ser","f"), no.space=TRUE)
```

```{r, K12 regression, ln_kwh and ln_kwhperstudent}
# RD: WE DON'T USE THIS IN OUR PAPER
#regression from kWh
K12.1 <- glm(ln_kWh ~  income + perc_eligible_frpm + perc_title1, data = K12_subset_no_outliers) #Step AIC picks
summary(K12.1)
K12.3 <- glm(ln_kWh ~ lcff + irr + dac + obf + resource + income + perc_eligible_frpm + perc_title1, data = K12_subset_no_outliers) #intuitive picks
summary(K12.3)
K12.5 <- glm( ln_kWhperstudent ~ lcffperstudent + dac + perc_eligible_frpm + perc_title1, data = K12_subset_no_outliers) #Step AIC picks; important to note this y variable does not meet normal assumptions
summary(K12.5)
K12.7 <- glm(ln_kWhperstudent ~ lcffperstudent + irr + dac + obf + resource + income + perc_eligible_frpm + perc_title1, data = K12_subset_no_outliers) #intuitive picks; important to note this y variable does not meet normal assumptions
summary(K12.7)
K12.1 <- glm(ln_kWh ~  lcff_scaled + lcffperstudent_scaled, data = K12_subset_no_outliers) #Step AIC picks
K12.3 <- glm(ln_kWh ~ lcff_scaled + lcffperstudent_scaled + irr + dac + obf + income_scaled + perc_eligible_frpm + perc_title1, data = K12_subset_no_outliers) #intuitive picks
K12.5 <- glm( ln_kWhperstudent ~ lcff_scaled + lcffperstudent_scaled + dac + perc_eligible_frpm + perc_title1, data = K12_subset_no_outliers) #Step AIC picks; important to note this y variable does not meet normal assumptions
K12.7 <- glm(ln_kWhperstudent ~ lcff_scaled + lcffperstudent_scaled + irr + dac + obf + income_scaled + perc_eligible_frpm + perc_title1, data = K12_subset_no_outliers) #intuitive picks; important to note this y variable does not meet normal assumptions
stargazer(K12.1, K12.3, K12.5, K12.7, type="text", title="Results", align=TRUE, omit.stat=c("LL","ser","f"), no.space=TRUE)
```


```{r, K12 regression table, budget}
#final regression picks BUDGET
#type="text" if you want to see the table in the console 
stargazer(K12.2, K12.4, K12.6, K12.8, type="html", title="Budget Regression Results (K12)", align=TRUE, dep.var.labels=c("Log of Budget", "Log Budget Per Student"), order=c("perc_eligible_frpm", "perc_title1", "lcff_scaled", "lcffperstudent_scaled", "income_scaled", "irr", "dac", "obf"), covariate.labels=c("Percent Eligible for Free or Reduced Meal Plan","Percent of Title 1 Schools", "LCFF (Scaled by 100000)","LCFF per student (Scaled by 100000)","Income (Scaled by 100000)", "IRR","DAC Proportion", "Percent of On-bill Financing"), omit.stat=c("LL","ser","f"), no.space=TRUE, out=paste0(output_path, "/Tables/", "regression_K12_budget.html"))
```
```{r, K12 regression table, kwh}
#final regression picks KWH
stargazer(K12.1, K12.3, K12.5, K12.7, type="text", title="Energy Savings Regression Results (K12)", align=TRUE, dep.var.labels=c("Log of kWh", "Log kWh Per Student"), order=c("perc_eligible_frpm", "perc_title1", "lcff_scaled", "lcffperstudent_scaled", "income_scaled", "irr", "dac", "obf"), covariate.labels=c("Percent Eligible for Free or Reduced Meal Plan","Percent of Title 1 Schools", "LCFF (Scaled by 100000)","LCFF per student (Scaled by 100000)","Income (Scaled by 100000)", "IRR","DAC Proportion", "Percent of On-bill Financing"), omit.stat=c("LL","ser","f"), no.space=TRUE)
```

```{r, K12 subsetting quantiles of budget, all K12}
#Create quantiles of budget
quantile(K12$budgetperstudent)
#create top and bottom quantile
K12fbottomq_budget = subset(K12, budgetperstudent <= 0) 
K12ftopq_budget = subset(K12, budgetperstudent > 0.81462460)
#create quantiles of energy savings
quantile(K12$kWhperstudent)
#create top and bottom quantile
K12fbottomq_energy = subset(K12, kWhperstudent <= 0) 
K12ftopq_energy = subset(K12, kWhperstudent > 1.618383175)
```


```{r, K12 t-tests}
#t tests to compare means of irr in top and bottom
t.test(K12fbottomq_budget$irr, K12ftopq_budget$irr, na.action = na.omit) #significant
t.test(K12fbottomq_energy$irr, K12ftopq_energy$irr, na.action = na.omit) #significant
#t tests to compare means of lcff in top and bottom
t.test(K12fbottomq_budget$lcffperstudent, K12ftopq_budget$lcffperstudent) #not sig
t.test(K12fbottomq_energy$lcffperstudent, K12ftopq_energy$lcffperstudent) #not sig
#t tests to compare means of perc_title_1 in top and bottom
t.test(K12fbottomq_budget$perc_title1, K12ftopq_budget$perc_title1) #not sig
t.test(K12fbottomq_energy$perc_title1, K12ftopq_energy$perc_title1) #not sig
#t tests to compare means of perc_frpm in top and bottom
t.test(K12fbottomq_budget$perc_eligible_frpm, K12ftopq_budget$perc_eligible_frpm) #not sig
t.test(K12fbottomq_energy$perc_eligible_frpm, K12ftopq_energy$perc_eligible_frpm) #not sig
#t tests to compare means of no_title_1 in top and bottom
t.test(K12fbottomq_budget$no_title1, K12ftopq_budget$no_title1) 
t.test(K12fbottomq_energy$no_title1, K12ftopq_energy$no_title1) 
#t tests to compare means of dac proportion in top and bottom
t.test(K12fbottomq_budget$dac, K12ftopq_budget$dac) #not sig
t.test(K12fbottomq_energy$dac, K12ftopq_energy$dac) #not sig
#t tests to compare means of ces score median in top and bottom
t.test(K12fbottomq_budget$ces_score, K12ftopq_budget$ces_score)  #not sig
t.test(K12fbottomq_energy$ces_score, K12ftopq_energy$ces_score) #not sig
#compare WA
t.test(K12fbottomq_budget$perc_wa, K12ftopq_budget$perc_wa)  #not sig
t.test(K12fbottomq_energy$perc_wa, K12ftopq_energy$perc_wa)  #not sig
#compare BA
t.test(K12fbottomq_budget$perc_ba, K12ftopq_budget$perc_ba)  #sig
t.test(K12fbottomq_energy$perc_ba, K12ftopq_energy$perc_ba)  #not sig
#compare AA
t.test(K12fbottomq_budget$perc_aa, K12ftopq_budget$perc_aa)  #sig
t.test(K12fbottomq_energy$perc_aa, K12ftopq_energy$perc_aa)  #sig
#compare IA
t.test(K12fbottomq_budget$perc_ia, K12ftopq_budget$perc_ia)  #sig
t.test(K12fbottomq_energy$perc_ia, K12ftopq_energy$perc_ia)  #sig
#compare NA
t.test(K12fbottomq_budget$perc_na, K12ftopq_budget$perc_na)  #not sig
t.test(K12fbottomq_energy$perc_na, K12ftopq_energy$perc_na)  #not sig 
#compare income per capita
t.test(K12fbottomq_budget$income, K12ftopq_budget$income) #sig
t.test(K12fbottomq_energy$income, K12ftopq_energy$income) #sig
```

```{r, K12 Mann-Whitney}
#compare WA
wilcox.test(K12fbottomq_budget$perc_wa, K12ftopq_budget$perc_wa)  #W = 280, p-value = 0.0209 sig
wilcox.test(K12fbottomq_energy$perc_wa, K12ftopq_energy$perc_wa)  #W = 284, p-value = 0.06052 not sig
#compare BA
wilcox.test(K12fbottomq_budget$perc_ba, K12ftopq_budget$perc_ba)  #W = 100, p-value = 0.00935 sig
wilcox.test(K12fbottomq_energy$perc_ba, K12ftopq_energy$perc_ba)  #W = 128, p-value = 0.03676 sig
#compare AA
wilcox.test(K12fbottomq_budget$perc_aa, K12ftopq_budget$perc_aa)  #W = 63, p-value = 0.0001866 sig
wilcox.test(K12fbottomq_energy$perc_aa, K12ftopq_energy$perc_aa)  #W = 83, p-value = 0.0008458 sig
#compare IA
wilcox.test(K12fbottomq_budget$perc_ia, K12ftopq_budget$perc_ia)  #W = 315, p-value = 0.0007997 sig
wilcox.test(K12fbottomq_energy$perc_ia, K12ftopq_energy$perc_ia)  #W = 317, p-value = 0.005653 sig
#compare NA
wilcox.test(K12fbottomq_budget$perc_na, K12ftopq_budget$perc_na)  #W = 92, p-value = 0.004585 sig
wilcox.test(K12fbottomq_energy$perc_na, K12ftopq_energy$perc_na)  #W = 117, p-value = 0.01715 sig
```

```{r, K12 subsetting budget per student quantiles, only participators}
#curious to see how t-tests differ when its just within the group that is participating ((K12 SUBSET))
quantile(K12_subset$budgetperstudent)
K12sbottomq_budget = subset(K12_subset, budgetperstudent <= 0.22256311)
K12stopq_budget = subset(K12_subset, budgetperstudent > 2.87458264)
quantile(K12_subset$kWhperstudent)
K12sbottomq_energy = subset(K12_subset, kWhperstudent <= 0.3356844)
K12stopq_energy = subset(K12_subset, kWhperstudent > 4.4421836)
```

```{r, K12 t-tests, top and bottom quantiles, only particpants, table 4}
# dac
var.test(K12sbottomq_budget$dac, K12stopq_budget$dac) # not sig diff
apa(t.test(K12sbottomq_budget$dac, K12stopq_budget$dac, var.equal = T))
t.test(K12sbottomq_budget$dac, K12stopq_budget$dac, var.equal = T)
# CES
var.test(K12sbottomq_budget$ces_score, K12stopq_budget$ces_score) # not sig diff
apa(t.test(K12sbottomq_budget$ces_score, K12stopq_budget$ces_score, var.equal = T))
t.test(K12sbottomq_budget$ces_score, K12stopq_budget$ces_score, var.equal = T)
# irr
var.test(K12sbottomq_budget$irr, K12stopq_budget$irr) # not sig diff
apa(t.test(K12sbottomq_budget$irr, K12stopq_budget$irr, var.equal = T))
t.test(K12sbottomq_budget$irr, K12stopq_budget$irr, var.equal = T)
# lcff
var.test(K12sbottomq_budget$lcffperstudent, K12stopq_budget$lcffperstudent) # not sig diff
apa(t.test(K12sbottomq_budget$lcffperstudent, K12stopq_budget$lcffperstudent, var.equal = T))
t.test(K12sbottomq_budget$lcffperstudent, K12stopq_budget$lcffperstudent, var.equal = T)
# frmp
var.test(K12sbottomq_budget$perc_eligible_frpm, K12stopq_budget$perc_eligible_frpm) # not sig diff
apa(t.test(K12sbottomq_budget$perc_eligible_frpm, K12stopq_budget$perc_eligible_frpm, var.equal = T))
t.test(K12sbottomq_budget$perc_eligible_frpm, K12stopq_budget$perc_eligible_frpm, var.equal = T)
# title 1
var.test(K12sbottomq_budget$perc_title1, K12stopq_budget$perc_title1) # not sig diff
apa(t.test(K12sbottomq_budget$perc_title1, K12stopq_budget$perc_title1, var.equal = T))
t.test(K12sbottomq_budget$perc_title1, K12stopq_budget$perc_title1, var.equal = T)
# income
var.test(K12sbottomq_budget$income, K12stopq_budget$income) # not sig diff
apa(t.test(K12sbottomq_budget$income, K12stopq_budget$income, var.equal = T))
t.test(K12sbottomq_budget$income, K12stopq_budget$income, var.equal = T)
#compare WA
var.test(K12sbottomq_budget$perc_wa, K12stopq_budget$perc_wa) # not sig diff
apa(t.test(K12sbottomq_budget$perc_wa, K12stopq_budget$perc_wa, var.equal = T))
t.test(K12sbottomq_budget$perc_wa, K12stopq_budget$perc_wa, var.equal = T)
#compare BA
var.test(K12sbottomq_budget$perc_ba, K12stopq_budget$perc_ba) # not sig diff
apa(t.test(K12sbottomq_budget$perc_ba, K12stopq_budget$perc_ba, var.equal = T))
t.test(K12sbottomq_budget$perc_ba, K12stopq_budget$perc_ba, var.equal = T)
#compare AA
var.test(K12sbottomq_budget$perc_aa, K12stopq_budget$perc_aa) # not sig diff
apa(t.test(K12sbottomq_budget$perc_aa, K12stopq_budget$perc_aa, var.equal = T))
t.test(K12sbottomq_budget$perc_aa, K12stopq_budget$perc_aa, var.equal = T) 
#compare IA
var.test(K12sbottomq_budget$perc_ia, K12stopq_budget$perc_ia) # SIG DIFF
apa(t.test(K12sbottomq_budget$perc_ia, K12stopq_budget$perc_ia))
t.test(K12sbottomq_budget$perc_ia, K12stopq_budget$perc_ia) 
#compare NA
var.test(K12sbottomq_budget$perc_na, K12stopq_budget$perc_na) # SIG DIFF
apa(t.test(K12sbottomq_budget$perc_na, K12stopq_budget$perc_na))
t.test(K12sbottomq_budget$perc_na, K12stopq_budget$perc_na)  
```

```{r, K12 spatial change capitalized letters}
#the county names don't match (our data has capitalized first letters County =/= county), so we have to change it
K12_subset_spatial <- K12_subset
K12_subset_spatial$budget_in_million <- K12_subset_spatial$budget / 10^6
K12_subset_spatial$county <- str_to_lower(K12_subset_spatial$county)
head(K12_subset_spatial) #check to see if the county names did change
```

```{r, K12 spatial check dimensions}
#merge on count name
#check dimensions before the merge
dim(K12_subset_spatial)
dim(CA_counties)
#merge
merged_K12_subset_spatial<- left_join(CA_counties, K12_subset_spatial, by = c("subregion"="county")) #the left_join takes all the unique values from left one and only add the matches from the right (doesn't matter in this case because they WILL match since we checked already)
dim(merged_K12_subset_spatial)

```


```{r, k12 spatial figure county with labels}
## County label map

## Counties with non-zero budgets
cnames_nonzero_budgets <- unique(merged_K12_subset_spatial)

## Get coordinates for labels
cnames <- aggregate(cbind(long,lat) ~ abbreviation, data=subset(merged_K12_subset_spatial, (!is.na(merged_K12_subset_spatial[,"roundedbudget"]))), FUN=function(x)mean(range(x)))

#Budget
map_budget <- ggplot(data = merged_K12_subset_spatial)+
  geom_polygon(aes(x = long, y = lat, group = group, fill= `budget_in_million`), color = 'gray', size = 0.2)+ #change the fill argument from plot to plot
  geom_text_repel(data=cnames, aes(x = long, y = lat, label = abbreviation), size=4) +
  coord_fixed(1.3)+
  ggtitle("Budget \n(million USD)")+ #change title from plot to plot
  theme_classic()+ #order matters in ggplot
  scale_fill_viridis(option='G', na.value='transparent', direction = -1) +
  theme(axis.title.x = element_blank(),
                           axis.title.y = element_blank(),
                           axis.text = element_blank(),
                           axis.ticks = element_blank(),
                           panel.grid = element_blank(),
                          axis.line = element_blank(),
                          legend.title = element_blank(),
                          legend.key.size = unit(0.5,'cm'),
                          legend.text = element_text(size=9),
                          title = element_text(size=9))

#map_budget <- map_budget + 
#  geom_text(data=merged_K12_subset_spatial, aes(x = long, y = lat, label = abbreviation), size=3)

map_budget
```

```{r}
test <- subset(merged_K12_subset_spatial, (!is.na(merged_K12_subset_spatial[,"roundedbudget"])))

```

```{r, K12 spatial final figure}
#visualize

## Counties with non-zero budgets
merged_K12_subset_spatial_counties_nonzero_budgets <- subset(merged_K12_subset_spatial, (!is.na(merged_K12_subset_spatial[,"roundedbudget"])))

## Counties to label (based on mention in the paper)
counties_to_label <- c("placer", "el dorado", "humboldt", "san joaquin", "stanislaus", "fresno", "santa barbara", "los angeles", "san francisco", "san diego")

merged_K12_subset_spatial_counties_nonzero_budgets_label <- merged_K12_subset_spatial_counties_nonzero_budgets[merged_K12_subset_spatial_counties_nonzero_budgets$subregion %in% counties_to_label,]

## Get coordinates for labels
cnames <- aggregate(cbind(long,lat) ~ abbreviation, data=merged_K12_subset_spatial_counties_nonzero_budgets_label, FUN=function(x)mean(range(x)))

#Budget
map_budget <- ggplot(data = merged_K12_subset_spatial)+
  geom_polygon(aes(x = long, y = lat, group = group, fill= `budget_in_million`), color = 'gray', size = 0.2)+ #change the fill argument from plot to plot
  coord_fixed(1.3)+
  ggtitle("Budget \n(million USD)")+ #change title from plot to plot
  theme_classic()+ #order matters in ggplot
  scale_fill_viridis(option='G', na.value='transparent', direction = -1) +
  theme(axis.title.x = element_blank(),
                           axis.title.y = element_blank(),
                           axis.text = element_blank(),
                           axis.ticks = element_blank(),
                           panel.grid = element_blank(),
                          axis.line = element_blank(),
                          legend.title = element_blank(),
                          legend.key.size = unit(0.5,'cm'),
                          legend.text = element_text(size=9),
                          title = element_text(size=9))

#Log of Budget
map_logbudget <- ggplot(data = merged_K12_subset_spatial)+
  geom_polygon(aes(x = long, y = lat, group = group, fill= `ln_budget`), color = 'gray', size = 0.2)+ #change the fill argument from plot to plot
  coord_fixed(1.3)+
  ggtitle("Log of Budget")+ #change title from plot to plot
  theme_classic()+ #order matters in ggplot
  scale_fill_viridis(option='G', na.value='transparent') +
  theme(axis.title.x = element_blank(),
                           axis.title.y = element_blank(),
                           axis.text = element_blank(),
                           axis.ticks = element_blank(),
                           panel.grid = element_blank(),
                          axis.line = element_blank(),
                          legend.title = element_blank(),
                          legend.key.size = unit(0.5,'cm'),
                          legend.text = element_text(size=9),
                          title = element_text(size=9))

#Free and reduced meal Plan
map_frpm <- ggplot(data = merged_K12_subset_spatial)+
  geom_polygon(aes(x = long, y = lat, group = group, fill= `perc_eligible_frpm`), color = 'gray', size = 0.2)+ #change the fill argument from plot to plot
  coord_fixed(1.3)+
  ggtitle("Students Eligible for Free \nand Reduced Meal Share")+ #change title from plot to plot
  theme_classic()+ #order matters in ggplot
  scale_fill_viridis(option='G', na.value='transparent', direction = -1) +
  theme(axis.title.x = element_blank(),
                           axis.title.y = element_blank(),
                           axis.text = element_blank(),
                           axis.ticks = element_blank(),
                           panel.grid = element_blank(),
                          axis.line = element_blank(),
                          legend.title = element_blank(),
                          legend.key.size = unit(0.5,'cm'),
                          legend.text = element_text(size=9),
                          title = element_text(size=9))

# Rurality IRR
map_irr <- ggplot(data = merged_K12_subset_spatial)+
  geom_polygon(aes(x = long, y = lat, group = group, fill= `irr`), color = 'gray', size = 0.2)+ #change the fill argument from plot to plot
  coord_fixed(1.3)+
  ggtitle("Rurality \n(Index of Relative Rurality)")+ #change title from plot to plot
  theme_classic()+ #order matters in ggplot
  scale_fill_viridis(option='G', na.value='transparent', direction = -1) +
  theme(axis.title.x = element_blank(),
                           axis.title.y = element_blank(),
                           axis.text = element_blank(),
                           axis.ticks = element_blank(),
                           panel.grid = element_blank(),
                          axis.line = element_blank(),
                          legend.title = element_blank(),
                          legend.key.size = unit(0.5,'cm'),
                          legend.text = element_text(size=9),
                          title = element_text(size=9))

#Budget per student
map_budgetperstudent <- ggplot(data = merged_K12_subset_spatial)+
  geom_polygon(aes(x = long, y = lat, group = group, fill= `budgetperstudent`), color = 'gray', size = 0.2)+ #change the fill argument from plot to plot
  geom_text_repel(data=cnames, aes(x = long, y = lat, label = abbreviation), size=2, max.overlaps = Inf, segment.alpha=0.5, min.segment.length=0.1, force=1, force_pull=1) +
  coord_fixed(1.3)+
  ggtitle("Budget per student \n(USD)")+ #change title from plot to plot
  theme_classic()+ #order matters in ggplot
  scale_fill_viridis(option='G', na.value='transparent', direction = -1) +
  theme(axis.title.x = element_blank(),
                           axis.title.y = element_blank(),
                           axis.text = element_blank(),
                           axis.ticks = element_blank(),
                           panel.grid = element_blank(),
                          axis.line = element_blank(),
                          legend.title = element_blank(),
                          legend.key.size = unit(0.5,'cm'),
                          legend.text = element_text(size=9),
                          title = element_text(size=9))

#Log of Budget per student
map_logbudgetperstudent <- ggplot(data = merged_K12_subset_spatial)+
  geom_polygon(aes(x = long, y = lat, group = group, fill= `ln_budgetperstudent`), color = 'gray', size = 0.2)+ #change the fill argument from plot to plot
  coord_fixed(1.3)+
  ggtitle("Budget per student \n(USD)")+ #change title from plot to plot
  theme_classic()+ #order matters in ggplot
  scale_fill_viridis(option='G', na.value='transparent') +
  theme(axis.title.x = element_blank(),
                           axis.title.y = element_blank(),
                           axis.text = element_blank(),
                           axis.ticks = element_blank(),
                           panel.grid = element_blank(),
                          axis.line = element_blank(),
                          legend.title = element_blank(),
                          legend.key.size = unit(0.5,'cm'),
                          legend.text = element_text(size=9),
                          title = element_text(size=9))

# Title 1 schools share
map_title1 <- ggplot(data = merged_K12_subset_spatial)+
  geom_polygon(aes(x = long, y = lat, group = group, fill= `perc_title1`), color = 'gray', size = 0.2)+ #change the fill argument from plot to plot
  coord_fixed(1.3)+
  ggtitle("Share of Title 1 Schools")+ #change title from plot to plot
  theme_classic()+ #order matters in ggplot
  scale_fill_viridis(option='G', na.value='transparent', direction = -1) +
  theme(axis.title.x = element_blank(),
                           axis.title.y = element_blank(),
                           axis.text = element_blank(),
                           axis.ticks = element_blank(),
                           panel.grid = element_blank(),
                          axis.line = element_blank(),
                          legend.title = element_blank(),
                          legend.key.size = unit(0.5,'cm'),
                          legend.text = element_text(size=9),
                          title = element_text(size=9))

#Disadvantaged community proportion
map_dac <- ggplot(data = merged_K12_subset_spatial)+
  geom_polygon(aes(x = long, y = lat, group = group, fill= `dac`), color = 'gray', size = 0.2)+ #change the fill argument from plot to plot
  coord_fixed(1.3)+
  ggtitle("Disadvantaged Community \nProportion (DAC)")+ #change title from plot to plot
  theme_classic()+ #order matters in ggplot
  scale_fill_viridis(option='G', na.value='transparent', direction = -1) +
  theme(axis.title.x = element_blank(),
                           axis.title.y = element_blank(),
                           axis.text = element_blank(),
                           axis.ticks = element_blank(),
                           panel.grid = element_blank(),
                          axis.line = element_blank(),
                          legend.title = element_blank(),
                          legend.key.size = unit(0.5,'cm'),
                          legend.text = element_text(size=9),
                          title = element_text(size=9))

# Arrange in a grid
spatial_distribution_K12 <- grid.arrange(map_budget, map_frpm, map_irr, map_budgetperstudent, map_title1, map_dac, ncol=3)

spatial_distribution_K12

ggsave(file="spatial_distribution_K12_common_gradient.png", spatial_distribution_K12)


```


##Counties

```{r, Start Counties}
#read in data for K-12 EE programs 
counties <- read.csv("counties_3.csv")
```


```{r, counties transformations}
#log-transform 
counties$ln_kWh <- log(counties$kWh + 1)
counties$ln_rev <- log(counties$revenue)
counties$ln_population <- log(counties$population)
counties$ln_budget <- log(counties$budget + 1)
#round budget and kWh
counties$roundedbudget <- round(counties$budget, 0)
counties$roundedkWh <- round(counties$kWh, 0)
#add a binary indicator
counties$ybudget <- ifelse(counties$budget>0, 1, 0)
counties$ykWh <- ifelse(counties$kWh>0, 1, 0)
#per person
counties$budgetpercapita <- counties$budget/counties$population
counties$revpercapita <- counties$revenue/counties$population
counties$kWhpercapita <- counties$kWh/counties$population
counties$ln_budgetpercapita <- log(counties$budgetpercapita + 1)
counties$ln_revpercapita <- log(counties$revpercapita + 1)
counties$ln_kWhpercapita <- log(counties$kWhpercapita + 1)
#round 
counties$roundedbudgetper <- round(counties$budgetpercapita, 0)
counties$roundedkWhper <- round(counties$kWhpercapita, 0)
#scaling
counties$revenue_scaled <- counties$revenue/100000
counties$population_scaled <- counties$population/100000
counties$income_scaled <- counties$income/100000
counties$revpercapita_scaled <- counties$revpercapita/100000
```

```{r, counties subsetting}
#only considering the counties that did participate 
counties_subset <- subset(counties, budget > 0)
#only considering the counties that did not participate 
counties_no = subset(counties, budget = 0)
#quantiles
quantile(counties$ln_population)
#split into groups based ln_enrollment 
counties_1 <- subset(counties, population <= 10.768725)
counties_2 <- subset(counties, population > 10.768725 & population <= 12.125893)
counties_3 <- subset(counties, population > 12.125893 & population <= 13.43974)
counties_4 <- subset(counties, population > 13.43974)
```

```{r, counties subsetting outliers}
#budget outliers
test.counties <- glm(budget ~ 1, data = counties_subset)
countiesCDs <- cooks.distance(test.counties)
# Plot the Cook's Distance using the traditional 4/n criterion
counties_sample_size <- nrow(counties_subset)
plot(countiesCDs, pch="*", cex=2, main="Influential Obs by Cooks distance\nbudget")  # plot cook's distance
abline(h = 4/counties_sample_size, col="red")  # add cutoff line
text(x=1:length(countiesCDs)+1, y=countiesCDs, labels=ifelse(countiesCDs>4/counties_sample_size, names(countiesCDs),""), col="red")  # add labels
#19 (LA), #37 (SD), and #38 (SF) are outliers

# ln budget outliers
test.counties.2 <- glm(ln_budget ~ 1, data = counties_subset)
countiesCDs.2 <- cooks.distance(test.counties.2)
# Plot the Cook's Distance using the traditional 4/n criterion
plot(countiesCDs.2, pch="*", cex=2, main="Influential Obs by Cooks distance
     \nln budget")  # plot cook's distance
abline(h = 4/counties_sample_size, col="red")  # add cutoff line
text(x=1:length(countiesCDs.2)+1, y=countiesCDs.2, labels=ifelse(countiesCDs.2>=4/counties_sample_size, names(countiesCDs.2),""), col="red")  # add labels
#47 SISKIYOU outlied

# ln budget per capita outliers
test.counties.3 <- glm(ln_budgetpercapita ~ 1, data = counties_subset)
countiesCDs.3 <- cooks.distance(test.counties.3)
# Plot the Cook's Distance using the traditional 4/n criterion
plot(countiesCDs.3, pch="*", cex=2, main="Influential Obs by Cooks distance\nln budget per capita")  # plot cook's distance
abline(h = 4/counties_sample_size, col="red")  # add cutoff line
text(x=1:length(countiesCDs.3)+1, y=countiesCDs.3, labels=ifelse(countiesCDs.3>4/counties_sample_size, names(countiesCDs.3),""), col="red")  # add labels
#34 (LA), #38 (SF) and 47 Siskiyou are outliers

```
```{r, counties subsetting outliers}
print(paste0("Exclude outliers: ",exclude_outliers))
#taking out the outliers 
counties_subset_no_outliers <- counties_subset[!(counties_subset$county %in% c("LOS ANGELES", "SAN DIEGO", "SAN FRANCISCO")),]
print(paste0("counties subset including outliers: ", nrow(counties_subset)))
print(paste0("counties subset excluding outliers: ", nrow(counties_subset_no_outliers)))

```

```{r, counties scatterplot}
plot.counties_subset <- data.frame(counties_subset$kWh, counties_subset$budget, counties_subset$income, counties_subset$irr, counties_subset$dac, counties_subset$ces_score, counties_subset$ces_percentile, counties_subset$obf, counties_subset$revenue, counties_subset$revpercapita, counties_subset$population) 
colnames(plot.counties_subset)<-c("kWh", "budget", "income", "irr", "dac", "ces_score", "ces_percentile", "obf", "revenue", "revenuepercap", "population") 
pairs.panels(plot.counties_subset, density = TRUE, cor=TRUE, lm=TRUE) 
```

```{r, counties visualize}
#explore our y-variables 
hist(counties$budget)
hist(counties$kWh)
hist(counties$ln_budget)
hist(counties$ln_kWh)
hist(counties$budgetpercapita)
hist(counties$kWhpercapita)
hist(counties$ln_budgetpercapita)
hist(counties$ln_kWhpercapita)
```
```{r, counties SUBSET visualize}
hist(counties_subset$budget)
hist(counties_subset$kWh)
hist(counties_subset$revenue)
hist(counties_subset$ln_budget)
hist(counties_subset$ln_kWh)
hist(counties_subset$budgetpercapita)
hist(counties_subset$kWhpercapita)
hist(counties_subset$ln_budgetpercapita)
hist(counties_subset$ln_kWhpercapita)
```

```{r, counties SUBSET NO OUTLIERS visualize}
hist(counties_subset_no_outliers$budget)
hist(counties_subset_no_outliers$kWh)
hist(counties_subset_no_outliers$revenue)
hist(counties_subset_no_outliers$ln_budget)
hist(counties_subset_no_outliers$ln_kWh)
hist(counties_subset_no_outliers$budgetpercapita)
hist(counties_subset_no_outliers$kWhpercapita)
hist(counties_subset_no_outliers$ln_budgetpercapita)
hist(counties_subset_no_outliers$ln_kWhpercapita)
```

```{r, County Step AIC selection, budget, NO outliers}
#performs stepwise model selection by AIC for budget
stepAIC(lm(ln_budget ~ revenue_scaled + revpercapita_scaled + dac + irr + population_scaled + obf + income_scaled, data = counties_subset_no_outliers))
#ln_budgetpercapita ~ revpercapita_scaled + population_scaled + obf, data = counties_subset
#ln_budget ~ revenue_scaled + revpercapita_scaled + irr + population_scaled + obf, data = counties_subset
```

```{r, County Step AIC selection, budget per capita, NO outliers}
stepAIC(lm(ln_budgetpercapita ~ revenue_scaled + revpercapita_scaled + dac + irr + population_scaled + obf + income_scaled, data = counties_subset_no_outliers))
```

```{r, County Step AIC selection, budget, WITH outliers}
stepAIC(lm(ln_budget ~ revenue_scaled + revpercapita_scaled + dac + irr + population_scaled + obf + income_scaled, data = counties_subset))
```

```{r, County Step AIC selection, budget per capita, WITH outliers}
stepAIC(lm(ln_budgetpercapita ~ revenue_scaled + revpercapita_scaled + dac + irr + population_scaled + obf + income_scaled, data = counties_subset))
```

```{r, County Step AIC selection, kWh}
# WE DONT USE THIS IN OUR PAPER, WE INCLUDE OUTLIERS
#performs stepwise model selection by AIC for kWh
stepAIC(lm(ln_kWh ~ revenue_scaled + revpercapita_scaled + dac + irr + population_scaled + obf + income_scaled, data = counties_subset))
#ln_kWhpercapita ~ revpercapita_scaled + irr + population_scaled, data = counties_subset
#ln_kWh ~ revenue_scaled + revpercapita_scaled + irr + population_scaled, data = counties_subset
```

```{r, counties regression, budget, no outliers}
#regression budget
counties.2.no_outliers <- glm(ln_budget ~ revenue_scaled + revpercapita_scaled + irr + population_scaled + obf, data = counties_subset_no_outliers) #Step AIC picks
summary(counties.2.no_outliers)
counties.4.no_outliers <- glm(ln_budget ~ revenue_scaled + revpercapita_scaled + dac + irr + population_scaled + obf + income_scaled, data = counties_subset_no_outliers) #intuitive picks
summary(counties.4.no_outliers)
counties.6.no_outliers <- glm(ln_budgetpercapita ~ revpercapita_scaled + population_scaled + obf, data = counties_subset_no_outliers) #Step AIC picks
summary(counties.6.no_outliers)
counties.8.no_outliers <- glm(ln_budgetpercapita ~ revenue_scaled + revpercapita_scaled + dac + irr + population_scaled + obf + income_scaled, data = counties_subset_no_outliers) #intuitive picks
summary(counties.8.no_outliers)
stargazer(counties.2.no_outliers, counties.4.no_outliers, counties.6.no_outliers, counties.8.no_outliers, type="text", title="Results", align=TRUE, omit.stat=c("LL","ser","f"), no.space=TRUE)
```

```{r, counties regression, budget, WITH outliers}
#regression budget
counties.2 <- glm(ln_budget ~ revpercapita_scaled + irr, data = counties_subset) #Step AIC picks
summary(counties.2)
counties.4 <- glm(ln_budget ~ revenue_scaled + revpercapita_scaled + dac + irr + population_scaled + obf + income_scaled, data = counties_subset) #intuitive picks
summary(counties.4)
counties.6 <- glm(ln_budgetpercapita ~ revpercapita_scaled + dac, data = counties_subset) #Step AIC picks
summary(counties.6)
counties.8 <- glm(ln_budgetpercapita ~ revenue_scaled + revpercapita_scaled + dac + irr + population_scaled + obf + income_scaled, data = counties_subset) #intuitive picks
summary(counties.8)
stargazer(counties.2, counties.4, counties.6, counties.8, type="text", title="Results", align=TRUE, omit.stat=c("LL","ser","f"), no.space=TRUE)
```


```{r, counties regression, kWh}
# WE DON'T USE THIS IN OUR PAPER
#regression from kWh
counties.1 <- glm(ln_kWh ~  irr + population, data = counties_subset)
summary(counties.1) #Step AIC picks
counties.3 <- glm(ln_kWh ~ revenue + dac + irr + obf + income, data = counties_subset) #intuitive picks
summary(counties.3)
counties.5 <- glm(ln_kWhpercapita ~ revpercapita + population_scaled + income, data = counties_subset) #Step AIC picks
summary(counties.5)
counties.7 <- glm(ln_kWhpercapita ~ revpercapita + dac + irr + obf + income, data = counties_subset) #intuitive picks
summary(counties.7)
counties.1 <- glm(ln_kWh ~  revenue_scaled + revpercapita_scaled + irr + population_scaled, data = counties_subset) #Step AIC picks
counties.3 <- glm(ln_kWh ~ revenue_scaled + revpercapita_scaled + dac + irr + population_scaled + obf + income_scaled, data = counties_subset) #intuitive picks
counties.5 <- glm(ln_kWhpercapita ~ revpercapita_scaled + irr + population_scaled, data = counties_subset) #Step AIC picks
counties.7 <- glm(ln_kWhpercapita ~ revenue_scaled + revpercapita_scaled + dac + irr + population_scaled + obf + income_scaled, data = counties_subset) #intuitive picks
stargazer(counties.1, counties.3, counties.5, counties.7, type="text", title="Results", align=TRUE, omit.stat=c("LL","ser","f"), no.space=TRUE)
```

```{r, counties regression, budget, output table}
#final regression picks BUDGET
#to export table to nice format -> type="html", out= "tablecounty1.htm", title="Budget Regression......
stargazer(counties.2, counties.4, counties.6, counties.8, type="html", title="Budget Regression Results (County)", align=TRUE, dep.var.labels=c("Log of Budget", "Log Budget Per Capita"), order=c("revenue_scaled", "revpercapita_scaled", "income_scaled", "irr", "dac", "obf", "population_scaled"), covariate.labels=c("Revenue (Scaled by 100000)", "Revenue per capita (Scaled by 100000)", "Income (Scaled by 100000)","IRR","DAC Proportion", "Percent of On-bill Financing","Population (Scaled by 100000)"), omit.stat=c("LL","ser","f"), no.space=TRUE, out= paste0(output_path,"/Tables/", "regression_counties_budget.htm"))

```

```{r, counties regression, kWh}
# WE DON'T USE THIS IN OUR PAPER. 
#final regression picks KWH
stargazer(counties.1, counties.3, counties.5, counties.7, type="html", out= "tablecounty2.htm", title="Energy Savings Regression Results (County)", align=TRUE, dep.var.labels=c("Log of kWh", "Log kWh Per Capita"), order=c("revenue_scaled", "revpercapita_scaled", "income_scaled", "irr", "dac", "obf", "population_scaled"), covariate.labels=c("Revenue (Scaled by 100000)", "Revenue per capita (Scaled by 100000)", "Income (Scaled by 100000)","IRR","DAC Proportion", "Percent of On-bill Financing","Population (Scaled by 100000)"), omit.stat=c("LL","ser","f"), no.space=TRUE)
```

```{r, counties subsetting}
#Create quantiles of budget
quantile(counties_subset$budgetpercapita)
#create top and bottom quantile
countiesfbottomq_budget = subset(counties_subset, budgetpercapita <= 2.20621261)
countiesftopq_budget = subset(counties_subset, budgetpercapita > 8.38942916)
#create quantiles of energy savings
quantile(counties$kWhpercapita)
#create top and bottom quantile
countiesfbottomq_energy = subset(counties_subset, kWhpercapita <= 1.377546)
countiesftopq_energy = subset(counties_subset, kWhpercapita > 11.231349)
```

```{r, counties participating t tests}
#t tests to compare means of irr in top and bottom
var.test(countiesfbottomq_budget$irr, countiesftopq_budget$irr) # not sig
t.test(countiesfbottomq_budget$irr, countiesftopq_budget$irr, var.equal = TRUE)
apa(t.test(countiesfbottomq_budget$irr, countiesftopq_budget$irr, var.equal = TRUE))

#t tests to compare means of total revenue in top and bottom
var.test(countiesfbottomq_budget$revenue, countiesftopq_budget$revenue) # SIG
t.test(countiesfbottomq_budget$revenue, countiesftopq_budget$revenue, var.equal = FALSE)
apa(t.test(countiesfbottomq_budget$revenue, countiesftopq_budget$revenue, var.equal = F))

#t tests to compare means of population in top and bottom
var.test(countiesfbottomq_budget$population, countiesftopq_budget$population) # SIG
t.test(countiesfbottomq_budget$population, countiesftopq_budget$population, var.equal = FALSE)
apa(t.test(countiesfbottomq_budget$population, countiesftopq_budget$population, var.equal = F))

#t tests to compare means of dac proportion in top and bottom
var.test(countiesfbottomq_budget$dac, countiesftopq_budget$dac) # not sig
t.test(countiesfbottomq_budget$dac, countiesftopq_budget$dac, var.equal = T)
apa(t.test(countiesfbottomq_budget$dac, countiesftopq_budget$dac, var.equal = T))

#t tests to compare means of ces score median in top and bottom
var.test(countiesfbottomq_budget$ces_score, countiesftopq_budget$ces_score) # not sig
t.test(countiesfbottomq_budget$ces_score, countiesftopq_budget$ces_score, var.equal = T)
apa(t.test(countiesfbottomq_budget$ces_score, countiesftopq_budget$ces_score, var.equal = T))

#t tests to compare means of mean income in top and bottom
var.test(countiesfbottomq_budget$income, countiesftopq_budget$income) # not sig
t.test(countiesfbottomq_budget$income, countiesftopq_budget$income, var.equal = T)
apa(t.test(countiesfbottomq_budget$income, countiesftopq_budget$income, var.equal = T))

# perc african american
var.test(countiesfbottomq_budget$perc_ba, countiesftopq_budget$perc_ba) # not sig
t.test(countiesfbottomq_budget$perc_ba, countiesftopq_budget$perc_ba, var.equal = T)
apa(t.test(countiesfbottomq_budget$perc_ba, countiesftopq_budget$perc_ba, var.equal = T))

# perc white
var.test(countiesfbottomq_budget$perc_wa, countiesftopq_budget$perc_wa) # not sig
t.test(countiesfbottomq_budget$perc_wa, countiesftopq_budget$perc_wa, var.equal = T)
apa(t.test(countiesfbottomq_budget$perc_wa, countiesftopq_budget$perc_wa, var.equal = T))

# perc asian
var.test(countiesfbottomq_budget$perc_aa, countiesftopq_budget$perc_aa) # not sig
t.test(countiesfbottomq_budget$perc_aa, countiesftopq_budget$perc_aa, var.equal = T)
apa(t.test(countiesfbottomq_budget$perc_aa, countiesftopq_budget$perc_aa, var.equal = T))

# perc am ind or alaska nat
var.test(countiesfbottomq_budget$perc_ia, countiesftopq_budget$perc_ia) # not sig
t.test(countiesfbottomq_budget$perc_ia, countiesftopq_budget$perc_ia, var.equal = T)
apa(t.test(countiesfbottomq_budget$perc_ia, countiesftopq_budget$perc_ia, var.equal = T))

# perc nat hawaii and PI
var.test(countiesfbottomq_budget$perc_na, countiesftopq_budget$perc_na) # not sig
t.test(countiesfbottomq_budget$perc_na, countiesftopq_budget$perc_na, var.equal = T)
apa(t.test(countiesfbottomq_budget$perc_na, countiesftopq_budget$perc_na, var.equal = T))

```

```{r, Counties spatial change capitalized letters}
#the county names don't match (our data has capitalized first letters County =/= county), so we have to change it
counties_subset_spatial <- counties_subset
counties_subset_spatial$budget_in_million <- counties_subset_spatial$budget / 10^6
counties_subset_spatial$county <- str_to_lower(counties_subset_spatial$county)
head(counties_subset_spatial) #check to see if the county names did change
```

```{r, Counties spatial check dimensions}
#merge on count name
#check dimensions before the merge
dim(counties_subset_spatial)
dim(CA_counties)
#merge
merged_counties_subset_spatial<- left_join(CA_counties, counties_subset_spatial, by = c("subregion"="county")) #the left_join takes all the unique values from left one and only add the matches from the right (doesn't matter in this case because they WILL match since we checked already)
dim(merged_counties_subset_spatial)
```


```{r, Counties spatial final figure}
#visualize

## Counties with non-zero budgets
merged_counties_subset_spatial_counties_nonzero_budgets <- subset(merged_counties_subset_spatial, (!is.na(merged_counties_subset_spatial[,"roundedbudget"])))

## Counties to label (based on mention in the paper)
counties_to_label <- c("inyo", "mono", "plumas", "siskiyou", "mariposa", "colusa", "glenn", "tuolumne", "mendocino", "calaveras", "orange", "riverside", "san bernardino", "humboldt", "santa barbara", "los angeles", "san francisco", "san diego")
#counties_to_label <- c("los angeles")

merged_counties_subset_spatial_counties_nonzero_budgets_label <- merged_counties_subset_spatial_counties_nonzero_budgets[merged_counties_subset_spatial_counties_nonzero_budgets$subregion %in% counties_to_label,]

## Get coordinates for labels
cnames <- aggregate(cbind(long,lat) ~ abbreviation, data=merged_counties_subset_spatial_counties_nonzero_budgets_label, FUN=function(x)mean(range(x)))

#Budget
map_budget_county <- ggplot(data = merged_counties_subset_spatial)+
  geom_polygon(aes(x = long, y = lat, group = group, fill= `budget_in_million`), color = 'gray', size = 0.2)+ #change the fill argument from plot to plot
  coord_fixed(1.3)+
  ggtitle("Budget in \n(million USD)")+ #change title from plot to plot
  theme_classic()+ #order matters in ggplot
  scale_fill_viridis(option='G', na.value='transparent', direction = -1) +
  theme(axis.title.x = element_blank(),
                           axis.title.y = element_blank(),
                           axis.text = element_blank(),
                           axis.ticks = element_blank(),
                           panel.grid = element_blank(),
                          axis.line = element_blank(),
                          legend.title = element_blank(),
                          legend.key.size = unit(0.5,'cm'),
                          legend.text = element_text(size=9),
                          title = element_text(size=9))

#Log of Budget county
map_logbudget_county <- ggplot(data = merged_counties_subset_spatial)+
  geom_polygon(aes(x = long, y = lat, group = group, fill= `ln_budget`), color = 'gray', size = 0.2)+ #change the fill argument from plot to plot
  coord_fixed(1.3)+
  ggtitle("Log of Budget")+ #change title from plot to plot
  theme_classic()+ #order matters in ggplot
  scale_fill_viridis(option='G', na.value='transparent', direction = -1) +
  theme(axis.title.x = element_blank(),
                           axis.title.y = element_blank(),
                           axis.text = element_blank(),
                           axis.ticks = element_blank(),
                           panel.grid = element_blank(),
                          axis.line = element_blank(),
                          legend.title = element_blank(),
                          legend.key.size = unit(0.5,'cm'),
                          legend.text = element_text(size=9),
                          title = element_text(size=9))


# Rurality IRR county
map_irr_county <- ggplot(data = merged_counties_subset_spatial)+
  geom_polygon(aes(x = long, y = lat, group = group, fill= `irr`), color = 'gray', size = 0.2)+ #change the fill argument from plot to plot
  coord_fixed(1.3)+
  ggtitle("Rurality \n(Index of Relative Rurality)")+ #change title from plot to plot
  theme_classic()+ #order matters in ggplot
  scale_fill_viridis(option='G', na.value='transparent', direction = -1) +
  theme(axis.title.x = element_blank(),
                           axis.title.y = element_blank(),
                           axis.text = element_blank(),
                           axis.ticks = element_blank(),
                           panel.grid = element_blank(),
                          axis.line = element_blank(),
                          legend.title = element_blank(),
                          legend.key.size = unit(0.5,'cm'),
                          legend.text = element_text(size=9),
                          title = element_text(size=9))


# Revenue per capita county
map_revpercapita_county <- ggplot(data = merged_counties_subset_spatial)+
  geom_polygon(aes(x = long, y = lat, group = group, fill= `revpercapita`), color = 'gray', size = 0.2)+ #change the fill argument from plot to plot
  coord_fixed(1.3)+
  ggtitle("Tax Revenue per Capita \n(USD)")+ #change title from plot to plot
  theme_classic()+ #order matters in ggplot
  scale_fill_viridis(option='G', na.value='transparent', direction = -1) +
  theme(axis.title.x = element_blank(),
                           axis.title.y = element_blank(),
                           axis.text = element_blank(),
                           axis.ticks = element_blank(),
                           panel.grid = element_blank(),
                          axis.line = element_blank(),
                          legend.title = element_blank(),
                          legend.key.size = unit(0.5,'cm'),
                          legend.text = element_text(size=9),
                          title = element_text(size=9))

#Budget per capita county
map_budgetpercapita_county <- ggplot(data = merged_counties_subset_spatial)+
  geom_polygon(aes(x = long, y = lat, group = group, fill= `budgetpercapita`), color = 'gray', size = 0.2)+ #change the fill argument from plot to plot
  geom_text_repel(data=cnames, aes(x = long, y = lat, label = abbreviation), size=2, max.overlaps = Inf, segment.alpha=0.5, min.segment.length=0.1, force=1, force_pull=1) +
  coord_fixed(1.3)+
  ggtitle("Budget per capita \n(USD)")+ #change title from plot to plot
  theme_classic()+ #order matters in ggplot
  scale_fill_viridis(option='G', na.value='transparent', direction = -1) +
  theme(axis.title.x = element_blank(),
                           axis.title.y = element_blank(),
                           axis.text = element_blank(),
                           axis.ticks = element_blank(),
                           panel.grid = element_blank(),
                          axis.line = element_blank(),
                          legend.title = element_blank(),
                          legend.key.size = unit(0.5,'cm'),
                          legend.text = element_text(size=9),
                          title = element_text(size=9))

#Log of Budget per capita county
map_logbudgetperstudent <- ggplot(data = merged_counties_subset_spatial)+
  geom_polygon(aes(x = long, y = lat, group = group, fill= `ln_budgetpercapita`), color = 'gray', size = 0.2)+ #change the fill argument from plot to plot
  coord_fixed(1.3)+
  ggtitle("Budget per capita \n(USD)")+ #change title from plot to plot
  theme_classic()+ #order matters in ggplot
  scale_fill_viridis(option='G', na.value='transparent', direction = -1) +
  theme(axis.title.x = element_blank(),
                           axis.title.y = element_blank(),
                           axis.text = element_blank(),
                           axis.ticks = element_blank(),
                           panel.grid = element_blank(),
                          axis.line = element_blank(),
                          legend.title = element_blank(),
                          legend.key.size = unit(0.5,'cm'),
                          legend.text = element_text(size=9),
                          title = element_text(size=9))

#Disadvantaged community proportion County
map_dac_county <- ggplot(data = merged_counties_subset_spatial)+
  geom_polygon(aes(x = long, y = lat, group = group, fill= `dac`), color = 'gray', size = 0.2)+ #change the fill argument from plot to plot
  coord_fixed(1.3)+
  ggtitle("Disadvantaged Community \nProportion (DAC)")+ #change title from plot to plot
  theme_classic()+ #order matters in ggplot
  scale_fill_viridis(option='G', na.value='transparent', direction = -1) +
  theme(axis.title.x = element_blank(),
                           axis.title.y = element_blank(),
                           axis.text = element_blank(),
                           axis.ticks = element_blank(),
                           panel.grid = element_blank(),
                          axis.line = element_blank(),
                          legend.title = element_blank(),
                          legend.key.size = unit(0.5,'cm'),
                          legend.text = element_text(size=9),
                          title = element_text(size=9))


# Percent On-Bill Financing
map_obf_county <- ggplot(data = merged_counties_subset_spatial)+
  geom_polygon(aes(x = long, y = lat, group = group, fill= `obf`), color = 'gray', size = 0.2)+ #change the fill argument from plot to plot
  coord_fixed(1.3)+
  ggtitle("Percent of On-bill Financing")+ #change title from plot to plot
  theme_classic()+ #order matters in ggplot
  scale_fill_viridis(option='G', na.value='transparent', direction = -1) +
  theme(axis.title.x = element_blank(),
                           axis.title.y = element_blank(),
                           axis.text = element_blank(),
                           axis.ticks = element_blank(),
                           panel.grid = element_blank(),
                          axis.line = element_blank(),
                          legend.title = element_blank(),
                          legend.key.size = unit(0.5,'cm'),
                          legend.text = element_text(size=9),
                          title = element_text(size=9))

# Arrange in a grid
spatial_distribution_county <- grid.arrange(map_budget_county, map_irr_county, map_revpercapita_county, map_budgetpercapita_county, map_dac_county, map_obf_county, ncol=3)

spatial_distribution_county

ggsave(file="spatial_distribution_county_common_gradient.png", spatial_distribution_county)

```


##Cities

```{r, Start Cities}
#read in data for cities EE programs 
cities <- read.csv("cities_3.csv")
```

```{r, cities transformations}
#log-transform 
cities$ln_budget <- log(cities$budget + 1)
cities$ln_kWh <- log(cities$kWh + 1)
cities$ln_rev <- log(cities$revenue)
#round budget and kWh
cities$roundedbudget <- round(cities$budget, 0)
cities$roundedkWh <- round(cities$kWh, 0)
#add a binary indicator
cities$ybudget <- ifelse(cities$budget>0, 1, 0)
cities$ykWh <- ifelse(cities$kWh>0, 1, 0)
#per student
cities$budgetpercapita <- cities$budget/cities$population
cities$revpercapita <- cities$revenue/cities$population
cities$kWhpercapita <- cities$kWh/cities$population
cities$ln_budgetpercapita <- log(cities$budgetpercapita)
cities$ln_revpercapita <- log(cities$revpercapita)
cities$ln_kWhpercapita <- log(cities$kWhpercapita + 1)
#round budget and kWh
cities$roundedbudgetper <- round(cities$budgetpercapita, 0)
cities$roundedkWhper <- round(cities$kWhpercapita, 0)
#scaling
cities$population_scaled <- cities$population/100000
cities$revenue_scaled <- cities$revenue/100000
cities$revpercapita_scaled <- cities$revpercapita/100000
cities$income_scaled <- cities$income/100000
```

```{r, city subsetting}
# remove cities with NAs for tax revenue; this also removed cities with budget = 0
cities_subset <- na.omit(cities)
print(nrow(cities_subset))
```


```{r, cities subsetting outliers}
# outliers for budget
test.cities <- glm(budget ~ 1, data = cities_subset)
citiesCDs <- cooks.distance(test.cities)
# Plot the Cook's Distance using the traditional 4/n criterion
cities_sample_size <- nrow(cities_subset)
plot(citiesCDs, pch="*", cex=2, main="Influential Obs by Cooks distance\nbudget")  # plot cook's distance
abline(h = 4/cities_sample_size, col="red")  # add cutoff line
text(x=1:length(citiesCDs)+1, y=citiesCDs, labels=ifelse(citiesCDs>4/cities_sample_size, names(citiesCDs),""), col="red")  # add labels
#326 (SAN FRANCISCO) and 325 (SAN DIEGO) are outliers and 201 (LA) and 26 (BAKERSFIELD)

# outliers for ln budget
test.cities.2 <- glm(ln_budget ~ 1, data = cities_subset)
citiesCDs.2 <- cooks.distance(test.cities.2)
# Plot the Cook's Distance using the traditional 4/n criterion
plot(citiesCDs.2, pch="*", cex=2, main="Influential Obs by Cooks distance\nln budget")  # plot cook's distance
abline(h = 4/cities_sample_size, col="red")  # add cutoff line
text(x=1:length(citiesCDs.2)+1, y=citiesCDs.2, labels=ifelse(citiesCDs.2>4/cities_sample_size, names(citiesCDs.2),""), col="red")  # add labels
#lol a bunch of outliers...

# outliers for ln budget per capita
test.cities.3 <- glm(ln_budgetpercapita ~ 1, data = cities_subset)
citiesCDs.3 <- cooks.distance(test.cities.3)
# Plot the Cook's Distance using the traditional 4/n criterion
plot(citiesCDs.3, pch="*", cex=2, main="Influential Obs by Cooks distance\nln budget per capita")  # plot cook's distance
abline(h = 4/cities_sample_size, col="red")  # add cutoff line
text(x=1:length(citiesCDs.3)+1, y=citiesCDs.3, labels=ifelse(citiesCDs.3>4/cities_sample_size, names(citiesCDs.3),""), col="red")  # add labels
# bunches of outliers again

```

```{r, cities subsetting, no outliers}
#taking out the outliers 
cities_subset_no_outliers <- cities_subset[!(cities_subset$city %in% c("SAN DIEGO", "SAN FRANCISCO", "BAKERSFIELD", "LOS ANGELES")),] 
```

```{r, cities scatterplot}
plot.cities_subset <- data.frame(cities_subset$kWh, cities_subset$budget, cities_subset$income, cities_subset$ruca, cities_subset$dac, cities_subset$ces_score, cities_subset$ces_percentile, cities_subset$obf, cities_subset$resource, cities_subset$revenue, cities_subset$population, cities_subset$revpercapita) 
colnames(plot.cities_subset)<-c("kWh", "budget", "income", "ruca", "dac", "ces_score", "ces_percentile", "obf","resource", "revenue", "population", "revpercap") 
pairs.panels(plot.cities_subset, density = TRUE, cor=TRUE, lm=TRUE) 
```

```{r, cities scatterplot}
plot.cities_y <- data.frame(cities_subset$kWh, cities_subset$budget, cities_subset$revenue, cities_subset$revenue_scaled, cities_subset$revpercapita, cities_subset$revpercapita_scaled, cities_subset$income, cities_subset$income_scaled, cities_subset$population_scaled, cities_subset$population) 
colnames(plot.cities_y)<-c("kWh", "budget", "revenue", "rev_scale", "revpercap","revpercap_scaled", "income","income_scaled", "population_scaled", "population") 
pairs.panels(plot.cities_y, density = TRUE, cor=TRUE, lm=TRUE) 
```

```{r, cities visualize}
#explore our y-variables for full cities dataset
hist(cities$budget)
hist(cities$kWh)
hist(cities$ln_budget)
hist(cities$ln_kWh)
hist(cities$budgetpercapita)
hist(cities$kWhpercapita)
hist(cities$ln_budgetpercapita)
hist(cities$ln_kWhpercapita)
#explore our y-variables for just cities that had tax revenue
hist(cities_subset$budget)
hist(cities_subset$kWh)
hist(cities_subset$ln_budget)
hist(cities_subset$ln_kWh)
hist(cities_subset$budgetpercapita)
hist(cities_subset$kWhpercapita)
hist(cities_subset$ln_budgetpercapita)
hist(cities_subset$ln_kWhpercapita)
```
```{r, cities visualize, no outliers}
#explore our y-variables for dataset WITHOUT outliers nor cities that didn't have tax revenue information 
hist(cities_subset_no_outliers$budget)
hist(cities_subset_no_outliers$kWh)
hist(cities_subset_no_outliers$ln_budget)
hist(cities_subset_no_outliers$ln_kWh)
hist(cities_subset_no_outliers$budgetpercapita)
hist(cities_subset_no_outliers$kWhpercapita)
hist(cities_subset_no_outliers$ln_budgetpercapita)
hist(cities_subset_no_outliers$ln_kWhpercapita)
```

```{r, City Step AIC selection, budget, NO outliers}
#performs stepwise model selection by AIC for budget
#all variables: revenue_scaled + revpercapita_scaled + ruca + dac + population_scaled + obf + income_scaled + resource 
# Removed "resource" (percent of resource programs) from regression because it is not a predictor. We had removed it before first submission but changes were not synced to git 5/5/2023
stepAIC(lm(ln_budget ~ revenue_scaled + revpercapita_scaled + ruca + dac + population_scaled + obf + income_scaled, data = cities_subset_no_outliers))
#ln_budget ~ revenue_scaled + obf + resource, data = cities_subset_no_outliers)
#ln_budgetpercapita ~ revenue_scaled + revpercapita_scaled + ruca + population_scaled + obf + resource, data = cities_subset_no_outliers)
```
```{r, City Step AIC selection, budget per capita, NO outliers}
#performs stepwise model selection by AIC for budget
#all variables: revenue_scaled + revpercapita_scaled + ruca + dac + population_scaled + obf + income_scaled
stepAIC(lm(ln_budgetpercapita ~ revenue_scaled + revpercapita_scaled + ruca + dac + population_scaled + obf + income_scaled, data = cities_subset_no_outliers))
#ln_budget ~ revenue_scaled + obf, data = cities_subset_no_outliers)
#ln_budgetpercapita ~ revenue_scaled + revpercapita_scaled + ruca + population_scaled + obf, data = cities_subset_no_outliers)
```

```{r, City Step AIC selection, kWh, NO outliers}
#performs stepwise model selection by AIC for kWh
stepAIC(lm(ln_kWh ~ revenue_scaled + revpercapita_scaled + ruca + dac + population_scaled + obf + income_scaled, data = cities_subset_no_outliers))
#result testing all of them: roundedkWhper ~ revpercapita + ruca + dac + obf + income, data = cities_subset_no_outliers)
#ln_kWh ~ revenue_scaled + obf, data = cities_subset_no_outliers)
#ln_kWhpercapita ~ revenue_scaled + ruca + dac + population_scaled + obf, data = cities_subset_no_outliers)
```

```{r, City Step AIC selection, budget, WITH outliers}
#performs stepwise model selection by AIC for budget
#all variables: revenue_scaled + revpercapita_scaled + ruca + dac + population_scaled + obf + income_scaled
stepAIC(lm(ln_budget ~ revenue_scaled + revpercapita_scaled + ruca + dac + population_scaled + obf + income_scaled, data = cities_subset))
```

```{r, City Step AIC selection, budget per capita, WITH outliers}
#performs stepwise model selection by AIC for budget
#all variables: revenue_scaled + revpercapita_scaled + ruca + dac + population_scaled + obf + income_scaled
stepAIC(lm(ln_budgetpercapita ~ revenue_scaled + revpercapita_scaled + ruca + dac + population_scaled + obf + income_scaled, data = cities_subset))

```

```{r, City Step AIC selection, kWh, WITH outliers}
# WE DONT USE THIS IN OUT PAPER
#performs stepwise model selection by AIC for kWh
stepAIC(lm(ln_kWh ~ revenue_scaled + revpercapita_scaled + ruca + dac + population_scaled + obf + income_scaled, data = cities_subset))

```

```{r, cities regression, NO outliers}
#regression from budget
cities.2.no_outliers <- glm(ln_budget ~  revpercapita_scaled + obf, data = cities_subset_no_outliers)
summary(cities.2.no_outliers) #Step AIC picks
cities.4.no_outliers <- glm(ln_budget ~ revenue_scaled + revpercapita_scaled + ruca + dac + population_scaled + obf + income_scaled, data = cities_subset_no_outliers) #intuitive picks
summary(cities.4.no_outliers)
cities.6.no_outliers <- glm(ln_budgetpercapita ~ revenue_scaled + revpercapita_scaled + ruca + population_scaled + obf, data = cities_subset_no_outliers) #Step AIC picks
summary(cities.6.no_outliers)
cities.8.no_outliers <- glm(ln_budgetpercapita ~ revenue_scaled + revpercapita_scaled + ruca + dac + population_scaled + obf + income_scaled, data = cities_subset_no_outliers) #intuitive picks
summary(cities.8.no_outliers)
```

```{r, cities regression, WITH outliers}
# Removed the variable "resource" labeled as "Percent of Resource Programs"
cities.2 <- glm(ln_budget ~ revpercapita_scaled + population_scaled + obf, data = cities_subset) #Step AIC picks
summary(cities.2)
cities.4 <- glm(ln_budget ~ revenue_scaled + revpercapita_scaled + ruca + dac + population_scaled + obf + income_scaled, data = cities_subset) #intuitive picks
summary(cities.4)
cities.6 <- glm(ln_budgetpercapita ~ revpercapita_scaled + ruca + obf, data = cities_subset) #Step AIC picks
summary(cities.6)
cities.8 <- glm(ln_budgetpercapita ~ revenue_scaled + revpercapita_scaled + ruca + dac + population_scaled + obf + income_scaled, data = cities_subset) #intuitive picks
summary(cities.8)
stargazer(cities.2, cities.4, cities.6, cities.8, type="text", title="Results", align=TRUE, omit.stat=c("LL","ser","f"), no.space=TRUE)
```

```{r, cities regression, kWh}
# WE DONT USE THIS IN OUR PAPER
#regression from kWh
cities.1 <- glm(ln_kWh ~  revenue + obf, data = cities_subset_no_outliers) #Step AIC picks
summary(cities.1)
cities.3 <- glm(ln_kWh ~ revenue + ruca + dac + obf + income, data = cities_subset_no_outliers) #intuitive picks
summary(cities.3)
cities.5 <- glm(ln_kWhpercapita ~ revpercapita + ruca + dac + obf, data = cities_subset_no_outliers) #Step AIC picks
summary(cities.5)
cities.7 <- glm(ln_kWhpercapita ~ revpercapita + ruca + dac + population + obf + income, data = cities_subset_no_outliers) #intuitive picks
summary(cities.7)
cities.1 <- glm(ln_kWh ~ revenue_scaled + obf, data = cities_subset_no_outliers) #Step AIC picks
cities.3 <- glm(ln_kWh ~ revenue_scaled + revpercapita_scaled + ruca + dac + population_scaled + obf + income_scaled, data = cities_subset_no_outliers) #intuitive picks
cities.5 <- glm(ln_kWhpercapita ~ revenue_scaled + ruca + dac + population_scaled + obf, data = cities_subset_no_outliers) #Step AIC picks
cities.7 <- glm(ln_kWhpercapita ~ revpercapita_scaled + ruca + dac + population_scaled + obf + income_scaled, data = cities_subset_no_outliers) #intuitive picks
cities.7 <- glm(ln_kWhpercapita ~ revenue_scaled + revpercapita_scaled + ruca + dac + population_scaled + obf + income_scaled, data = cities_subset_no_outliers) #intuitive picks
stargazer(cities.1, cities.3, cities.5, cities.7, type="text", title="Results", align=TRUE, omit.stat=c("LL","ser","f"), no.space=TRUE)
```

```{r, cities regression budget, output table}
#final regression picks BUDGET
# Removed the variable "resource" labeled as "Percent of Resource Programs"
stargazer(cities.2, cities.4, cities.6, cities.8, type="html", title="Budget Regression Results (Cities)", align=TRUE, dep.var.labels=c("Log of Budget", "Log Budget Per Capita"), order=c("revenue_scaled","revpercapita_scaled", "income_scaled", "ruca", "dac", "obf", "population_scaled"), covariate.labels=c("Revenue (Scaled by 100000)", "Revenue per Capita (Scaled by 100000)","Income (Scaled by 100000)", "RUCA","DAC Proportion", "Percent of On-bill Financing","Population (Scaled by 100000)"), omit.stat=c("LL","ser","f"), no.space=TRUE, out= paste0(output_path,"/Tables/","regression_cities_budget.htm"))

```

```{r, cities regression kWh}
# WE DONT USE THIS IN OUR PAPER
#final regression picks KWH
# Removed the variable "resource" labeled as "Percent of Resource Programs"
stargazer(cities.1, cities.3, cities.5, cities.7, type="text", title="Energy Savings Regression Results (Cities)", align=TRUE, dep.var.labels=c("Log of kWh", "Log kWh Per Capita"), order=c("revenue_scaled","revpercapita_scaled", "income_scaled", "ruca", "dac", "obf", "population_scaled"), covariate.labels=c("Revenue (Scaled by 100000)", "Revenue per Capita (Scaled by 100000)","Income (Scaled by 100000)", "RUCA","DAC Proportion", "Percent of On-bill Financing","Population (Scaled by 100000)"), omit.stat=c("LL","ser","f"), no.space=TRUE)
```

```{r, cities subsetting}
#Create quantiles of budget
quantile(cities_subset$budgetpercapita)
#create top and bottom quantile
citiesfbottomq_budget = subset(cities_subset, budgetpercapita <= 1.725953)
citiesftopq_budget = subset(cities_subset, budgetpercapita > 10.03911)
#create quantiles of energy savings
quantile(cities$kWhpercapita)
#create top and bottom quantile
citiesfbottomq_energy = subset(cities, kWhpercapita <= 1.141914)
citiesftopq_energy = subset(cities, kWhpercapita > 13.167434)
```

```{r, cities t-tests}
#t tests to compare means of dac proportion in top and bottom
var.test(citiesfbottomq_budget$dac, citiesftopq_budget$dac) # not sig
t.test(citiesfbottomq_budget$dac, citiesftopq_budget$dac, var.equal = T)
apa(t.test(citiesfbottomq_budget$dac, citiesftopq_budget$dac, var.equal = T))

#t tests to compare means of ces score median in top and bottom
var.test(citiesfbottomq_budget$ces_score, citiesftopq_budget$ces_score) # not sig
t.test(citiesfbottomq_budget$ces_score, citiesftopq_budget$ces_score, var.equal = T)
apa(t.test(citiesfbottomq_budget$ces_score, citiesftopq_budget$ces_score, var.equal = T))

#t tests to compare means of ruca in top and bottom
var.test(citiesfbottomq_budget$ruca, citiesftopq_budget$ruca) # SIG
t.test(citiesfbottomq_budget$ruca, citiesftopq_budget$ruca, var.equal = FALSE)
apa(t.test(citiesfbottomq_budget$ruca, citiesftopq_budget$ruca, var.equal = FALSE))

#t tests to compare means of population in top and bottom
var.test(citiesfbottomq_budget$population, citiesftopq_budget$population) # SIG
t.test(citiesfbottomq_budget$population, citiesftopq_budget$population, var.equal = FALSE)
apa(t.test(citiesfbottomq_budget$population, citiesftopq_budget$population, var.equal = FALSE))

#t tests to compare means of revenue in top and bottom
var.test(citiesfbottomq_budget$revenue, citiesftopq_budget$revenue) # SIG
t.test(citiesfbottomq_budget$revenue, citiesftopq_budget$revenue, var.equal = FALSE)
apa(t.test(citiesfbottomq_budget$revenue, citiesftopq_budget$revenue, var.equal = FALSE))

#t tests to compare means of income in top and bottom
var.test(citiesfbottomq_budget$income, citiesftopq_budget$income) # not sig
t.test(citiesfbottomq_budget$income, citiesftopq_budget$income, var.equal = T)
apa(t.test(citiesfbottomq_budget$income, citiesftopq_budget$income, var.equal = T))

#compare WA
var.test(citiesfbottomq_budget$perc_wa, citiesftopq_budget$perc_wa) # not sig
t.test(citiesfbottomq_budget$perc_wa, citiesftopq_budget$perc_wa, var.equal = T)
apa(t.test(citiesfbottomq_budget$perc_wa, citiesftopq_budget$perc_wa, var.equal = T))

#compare BA
var.test(citiesfbottomq_budget$perc_ba, citiesftopq_budget$perc_ba) # not sig
t.test(citiesfbottomq_budget$perc_ba, citiesftopq_budget$perc_ba, var.equal = T)
apa(t.test(citiesfbottomq_budget$perc_ba, citiesftopq_budget$perc_ba, var.equal = T))

#compare AA
var.test(citiesfbottomq_budget$perc_aa, citiesftopq_budget$perc_aa) # not sig
t.test(citiesfbottomq_budget$perc_aa, citiesftopq_budget$perc_aa, var.equal = T)
apa(t.test(citiesfbottomq_budget$perc_aa, citiesftopq_budget$perc_aa, var.equal = T))

#compare IA
var.test(citiesfbottomq_budget$perc_ia, citiesftopq_budget$perc_ia) # not sig
t.test(citiesfbottomq_budget$perc_ia, citiesftopq_budget$perc_ia, var.equal = T)
apa(t.test(citiesfbottomq_budget$perc_ia, citiesftopq_budget$perc_ia, var.equal = T))

#compare NA
var.test(citiesfbottomq_budget$perc_na, citiesftopq_budget$perc_na) # SIG
t.test(citiesfbottomq_budget$perc_na, citiesftopq_budget$perc_na, var.equal = F)
apa(t.test(citiesfbottomq_budget$perc_na, citiesftopq_budget$perc_na, var.equal = F))

```

```{r, cities Mann-Whitney}
#compare WA
wilcox.test(citiesfbottomq_budget$perc_wa, citiesftopq_budget$perc_wa)  #W = 5356, p-value = 0.7231 not sig
wilcox.test(citiesfbottomq_energy$perc_wa, citiesftopq_energy$perc_wa)  #W = 5043, p-value = 0.3407 not sig
#compare BA
wilcox.test(citiesfbottomq_budget$perc_ba, citiesftopq_budget$perc_ba)  #W = 5838, p-value = 0.4604 not sig
wilcox.test(citiesfbottomq_energy$perc_ba, citiesftopq_energy$perc_ba)  #W = 6265, p-value = 0.06571 not sig
#compare AA
wilcox.test(citiesfbottomq_budget$perc_aa, citiesftopq_budget$perc_aa)  #W = 6006, p-value = 0.2628 not sig
wilcox.test(citiesfbottomq_energy$perc_aa, citiesftopq_energy$perc_aa)  #W = 6324.5, p-value = 0.0481 sig
#compare IA
wilcox.test(citiesfbottomq_budget$perc_ia, citiesftopq_budget$perc_ia)  #W = 5534.5, p-value = 0.961 not sig
wilcox.test(citiesfbottomq_energy$perc_ia, citiesftopq_energy$perc_ia)  #W = 5166, p-value = 0.5019 not sig
#compare NA
wilcox.test(citiesfbottomq_budget$perc_na, citiesftopq_budget$perc_na)  #W = 6101.5, p-value = 0.1762 not sig
wilcox.test(citiesfbottomq_energy$perc_na, citiesftopq_energy$perc_na)  #W = 5496, p-value = 0.9347 not sig
```

```{r, stats}
print(paste0("K12 total budget: ", sum(K12_subset$budget)))
print(paste0("counties total budget: ", sum(counties_subset$budget)))
print(paste0("cities total budget: ", sum(cities_subset$budget)))
print(paste0("counties - share claims on-bill financing: ", sum(counties_subset$claims * counties_subset$obf/100) / sum(counties_subset$claims)))
print(paste0("K12 - share claims on-bill financing: ", sum(K12_subset$claims * K12_subset$obf/100) / sum(K12_subset$claims)))

```



