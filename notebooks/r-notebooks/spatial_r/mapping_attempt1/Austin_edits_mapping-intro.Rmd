---
title: "Mapping in R"
output: html_notebook
---

# getting ready

### load packages
if any of these packages are not installed on your system, install them by uncommenting the following section and running it:
```{r}
# install.packages("data.table")
# install.packages("tigris")
# install.packages("ggplot2")
# install.packages("hrbrthemes")
# install.packages("extrafont")
```

now, load the packages:
```{r}
library(data.table)
library(tigris)
library(ggplot2)
library(hrbrthemes)
library(extrafont)
```

### setting my data inputs
i like to set my data directory/directories and file(s) as variables at the beginning of my scripts (instead of calling on the full string in my script) so that's what i'm doing here
```{r}
old_cpuc_file   = 'cpuc_claims_county_2017_2019.csv'
```

# the actual mapping

## loading our data

### read in our county level data
``fread`` is the data.table package version of read.csv or read_csv. i like working in data.table because it's sooo much faster than base R (or tidyverse), but this is a preference thing
```{r}
cpuc_dt = fread(old_cpuc_file, header = T, colClasses = c('character', rep(NA, 10)))
# specify for first column = character
head(cpuc_dt)
```
also, i specify the first column as a character type because i know that's the column that's the county's FIPS code. if not specified, ``fread`` will detect it as a numeric type and get rid of the leading zeroes in the column

## using the tigris package to get maps of TIGER/Line dataset

we just need county maps for now, but tigris does offer more functionality. read about the package [here](https://github.com/walkerke/tigris).
```{r}
ca_counties = counties(state = 'CA')
head(ca_counties)
```

what does that ``ca_counties`` object look like if we just mapped it as is?
the ``geom_sf`` file in the ggplot2 package creates maps of shapefiles
```{r}
ggplot(ca_counties)  + 
  geom_sf()
```

## merging data

now that we have one object that's kind of like a shapefile (``ca_counties``) and we have our own data.table of variables we would actually want to plot (``cpuc_dt``), we can merge the two objects using the FIPS code column as the common key

```{r}
merge_dt = merge(ca_counties, cpuc_dt,
                 by.x = 'COUNTYFP',
                 by.y = 'county_fips')
head(merge_dt)
```

## creating choropleth maps of our data
let's map total gross measure costs as an example

### simple choropleth map

without making any stylistic changes, here's what a map using TotalGrossMeasureCost as the choropleth variable looks like:
```{r}
ggplot(merge_dt, aes(fill = TotalGrossMeasureCost/1e6)) +
  geom_sf()
```

that's the basis of it! visually I don't like how that looks so let's make some aesthetic changes

### map with some aesthetic changes
```{r}
map_costs = ggplot(merge_dt, aes(fill = TotalGrossMeasureCost/1e6)) +
  geom_sf(color = '#fafafa', lwd = 0.3) +
  labs(title = 'Gross measure costs by county (2017-2019)',
       x = NULL,
       y = NULL, 
       fill = 'Million USD') +
  guides(color = 'none') +
  scale_fill_gradient(low = '#b5c5dc', high = '#074360') +
  theme_ipsum(grid = FALSE) +
  theme(axis.title = element_blank(),
        axis.ticks = element_blank(),
        axis.text.x = element_blank(),
        axis.text.y = element_blank(),
        axis.line.x = element_blank(),
        axis.line.y = element_blank())
map_costs
```
a bit better, but it seems like LA county is vastly different from the rest, right? that's because LA county's total gross measure costs is significantly higher than all other counties, so it's skewing the visualization.

### distribution of gross measure costs

we can verify by plotting some density plots or histograms
```{r}
ggplot(cpuc_dt, aes(x = TotalGrossMeasureCost/1e6)) +
  geom_density() +
  theme_ipsum(grid = 'Y')
```

```{r}
ggplot(cpuc_dt, aes(x = TotalGrossMeasureCost/1e6)) +
  geom_histogram(binwidth = 1) +
  theme_ipsum(grid = 'Y')
```
so yeah, LA county is the only county in the 30 million+ USD range (or even 20 million USD+). a better map might use different breaks, but i'm too lazy to do that right now :)  

## saving map

### saving as pdf

my preference is to save figures as PDFs -- they're vectorized, don't become blurry if you resize, and the file sizes are much smaller. the tricky part with PDFs is you should embed fonts onto the pdf so that people who may not have the font on their computer can still the text when they open the pdf
```{r}
ggsave(map_costs, 
       filename = here::here('figures', 'map-gross-measure-costs-by-county.pdf'), 
       width = 8, 
       height = 6.25)

embed_fonts(here::here('figures', 'map-gross-measure-costs-by-county.pdf'),
            outfile = here::here('figures', 'map-gross-measure-costs-by-county.pdf'))
```

### saving as png
png (or jpg and other similar file types) are still the standard, and google docs doesn't let you put in pdf images so we should also save pngs sometimes
```{r}
ggsave(map_costs, 
       filename = here::here('figures', 'map-gross-measure-costs-by-county.png'), 
       width = 8, 
       height = 6.25,
       dpi = 600)
```

