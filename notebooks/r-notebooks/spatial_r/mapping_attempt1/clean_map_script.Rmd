---
title: "clean map script"
author: "Austin Covey"
date: "5/21/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r, load packages}
library(sf)
library(data.table)
library(tigris)
library(ggplot2)
library(maps)
library(tmap)
library(USAboundaries)
library(maptools)
library(tidyverse)
library(stringr)
library(viridis)
library(sp)
```

```{r, load data}
cpuc_file   = 'better_cpuc_compiled.csv'
#df <- fread(cpuc_file) #, colClasses = c('character', df$county_fips))

df <- fread(cpuc_file, header = T, colClasses = c('character', rep(NA, 11)))
# best practice is to classify column as a character as you read the data in.

#rep(NA,11)= NA, NA, NA...... 11 times


# We lack leading zeroes (best practice to have them).
```

```{r, Start Here}

#make a data frame
all_counties<- map_data("county")
# Lot of observations, this stores geometries of county polygons in an inefficient way (there are 3000 counties in US, but way more observations (storing in point, line way))

#visualize
ggplot(data=all_counties)+
  geom_polygon(aes(x = long, y = lat, fill = region, group = group))+ #if you were using a different coord system you would have to change long and lat
  # fill indicates what we want to colored in, in this case we're doing the states (region=state)
  # group is extremely important. There are lots of point values in this data. Group tells R that all of these points belong in a county
  coord_fixed(1.3)+
  guides(fill = FALSE) #if change to fill = any other color, then you would see the outline of all of the counties (county lines are there even when you put FALSE; however we don't see them at this granularity)

```

```{r, subset to CA}
CA_counties<- subset(x = all_counties, subset = region == "california")
# Check subset with: table(CA_counties$region)
```

```{r, make lowercase}
#the county names don't match (our data has capitalized first letters County =/= county), so we have to change it
df_edited <- df
df_edited$County <- str_to_lower(df_edited$County)
head(df_edited) #check to see if the county names did change
```

```{r, merge on count name}
#check dimensions before the merge 
dim(df_edited)
dim(CA_counties)

#merge
merged_data<- left_join(CA_counties, df_edited, by = c("subregion"="County")) #the left_join takes all the unique values from left one and only add the matches from the right (doesn't matter in this case because they WILL match since we checked already)
dim(merged_data) 
```

```{r, visualize mean income}

#Mean Income
ggplot(data = merged_data)+
  geom_polygon(aes(x = long, y = lat, group = group, fill= `Mean Income`))+ #change the fill argument from plot to plot
  coord_fixed(1.3)+
  ggtitle("Mean Household Income by County")+ #change title from plot to plot
  theme_classic()+ #order matters in ggplot
  scale_fill_viridis() +
  theme(axis.title.x = element_blank(),
                           axis.title.y = element_blank(),
                           axis.text = element_blank(),
                           axis.ticks = element_blank(),
                           panel.grid = element_blank())

#there are ways to change colors and get rid of the axis (read more into ggplot:http://sape.inf.usi.ch/quick-reference/ggplot2/colour)

```

```{r, visualize log pop}

log_pop <- log(merged_data$Population + 1)
merged_data$log_pop <- log(merged_data$Population + 1)

# LOG Population
ggplot(data = merged_data) +
  geom_polygon(aes(x = long, y = lat, group = group, fill= `log_pop`)) + 
  coord_fixed(1.3) +
  ggtitle("County Population (LOG)") +
  theme_classic() +
  scale_fill_viridis() +
  theme(axis.title.x = element_blank(),
                           axis.title.y = element_blank(),
                           axis.text = element_blank(),
                           axis.ticks = element_blank(),
                           panel.grid = element_blank())
```

```{r, visualize energy savings}
# Make log?
log_savings <- log(merged_data$TotalFirstYearGrosskWh + 1)
merged_data$log_savings <- log(merged_data$TotalFirstYearGrosskWh + 1)

ggplot(data = merged_data) +
  geom_polygon(aes(x = long, y = lat, group = group, fill= `log_savings`)) + 
  coord_fixed(1.3) +
  ggtitle("Log Energy Savings by County") + 
  theme_classic() + 
  scale_fill_viridis() +
  theme(axis.title.x = element_blank(),
                           axis.title.y = element_blank(),
                           axis.text=element_blank(),
                           axis.ticks = element_blank(),
                           panel.grid = element_blank())

#Energy Savings
ggplot(data = merged_data) +
  geom_polygon(aes(x = long, y = lat, group = group, fill= `TotalFirstYearGrosskWh`)) + 
  coord_fixed(1.3) +
  ggtitle("Energy Savings by County") + 
  theme_classic() + 
  scale_fill_viridis() +
  theme(axis.title.x = element_blank(),
                           axis.title.y = element_blank(),
                           axis.text=element_blank(),
                           axis.ticks = element_blank(),
                           panel.grid = element_blank())

```

```{r, visualize budget}

#Budget
ggplot(data = merged_data)+
  geom_polygon(aes(x = long, y = lat, group = group, fill= `Budget`))+ 
  coord_fixed(1.3)+
  ggtitle("Budget by County")+ 
  theme_classic()+ 
  theme(axis.title.x = element_blank(),
                           axis.title.y = element_blank(),
                           axis.text=element_blank(),
                           axis.ticks = element_blank(),
                           panel.grid = element_blank())

```

```{r, visualize IRR}

#IRR
ggplot(data = merged_data)+
  geom_polygon(aes(x = long, y = lat, group = group, fill= `IRR`))+ 
  coord_fixed(1.3)+
  ggtitle("Relative Rurality by County")+ 
  theme_classic()+ 
  theme(axis.title.x = element_blank(),
                           axis.title.y = element_blank(),
                           axis.text=element_blank(),
                           axis.ticks = element_blank(),
                           panel.grid = element_blank())

```

```{r, visualize tax revenue}

#Tax Revenue
ggplot(data = merged_data)+
  geom_polygon(aes(x = long, y = lat, group = group, fill= `Tax Revenue (2016-2018)`))+ 
  coord_fixed(1.3)+
  ggtitle("Tax Revenue by County")+ 
  theme_classic()+ 
  theme(axis.title.x = element_blank(),
                           axis.title.y = element_blank(),
                           axis.text=element_blank(),
                           axis.ticks = element_blank(),
                           panel.grid = element_blank())

```

```{r, visualize CES score}

#CES Score
ggplot(data = merged_data)+
  geom_polygon(aes(x = long, y = lat, group = group, fill= `CES Score Median`))+ 
  coord_fixed(1.3)+
  ggtitle("CES Score Median by County")+ 
  theme_classic()+ 
  theme(axis.title.x = element_blank(),
                           axis.title.y = element_blank(),
                           axis.text=element_blank(),
                           axis.ticks = element_blank(),
                           panel.grid = element_blank())

```
```{r}
typeof(CA_counties)
counties_as_sf <- st_as_sf(CA_counties,
                           coords = c('long', 'lat'),
                           crs = 4326)
#st_geometry_type(counties_as_sf)
#centroids <- getSpPPolygonsLabptSlots(CA_counties)
```

```{r, convert county point layer to a polygon layer}
CA_counties_polys = st_sf(
  aggregate(
    counties_as_sf$geometry,
    list(counties_as_sf$group),
    function(g){
       st_cast(st_combine(g),"POLYGON")}))
st_geometry_type(CA_counties_polys)

```

```{r, change CRS of counties polygon (want to do this b4 centroids)}
#st_crs(CA_counties_polys)
zip_codes_shape <- st_read("zipcodes/ZCTA2010.shp")
#st_crs(zip_codes_shape)
CA_albs <- st_crs(zip_codes_shape)
CA_counties_polys_2 <- st_transform(CA_counties_polys, crs = CA_albs)
st_crs(CA_counties_polys_2)
```

```{r, add state boudnary}
CA_state_boundary <- st_read("CA_state_boundary/CA_State_TIGER2016.shp")
st_transform(CA_state_boundary, crs = CA_albs)
st_crs(CA_state_boundary)
```

```{r, make centroids}
CA_counties_centroids <- st_centroid(CA_counties_polys_2)
#st_crs(CA_counties_centroids)
```

```{r, make dataframe with group numbers and fips to merge on}
new_df <- data.frame(group = c(157:214), county_fips = c(0:57))
```

```{r, merge new_df to df_edited then merge new_new to CA_counties_centroids}
new_new <- merge(new_df, df_edited, by = "county_fips", all = TRUE)
centroids_merge <- merge(CA_counties_centroids, new_new, by.x = "Group.1", by.y = "group")
```

```{r, merge merged_data to centroids}
# We have group in common
centroids_merge <- merge(CA_counties_centroids, merged_data, by.x = "Group.1", by.y = "group", all.x = TRUE, all.y = FALSE)
#head(centroids_merge)
```

```{r}
ggplot() +
  geom_sf(data = CA_counties_polys) +
  geom_sf(data = centroids_merge, aes(size = Budget), shape = 1) +
  coord_sf()
```

```{r, load CA places hope for cities}
CA_places_boundaries <- st_read("CA_places/CA_Places_TIGER2016.shp")
cities_df <- read_csv("cities_2.csv")
```

```{r, investigate CA_places_boundaries}
#st_geometry_type(CA_places_boundaries)
#st_crs(CA_places_boundaries)
st_transform(CA_places_boundaries, crs = CA_albs)
st_crs(CA_places_boundaries)
```

```{r, map places}
ggplot()+
  geom_sf(data = CA_places_boundaries)+
  coord_sf()
```

```{r, merge boundaires to cities_df}
CA_places_boundaries$NAME <- str_to_upper(CA_places_boundaries$NAME)
cities_df_sf_merge <- merge(CA_places_boundaries, cities_df, by.x = "NAME", by.y = "SiteCity", all.x = FALSE, all.y = TRUE)
```

```{r}
cities_df_sf_merge <- na.omit(cities_df_sf_merge)
```

```{r, map places}
ggplot() +
  geom_sf(data = CA_state_boundary) +
  geom_sf(data = cities_df_sf_merge, aes(fill= cities_df_sf_merge$Budget), color = NA) +
  scale_fill_viridis(name = "Budget") +
  theme_classic() +
  theme(axis.title.x = element_blank(),
                           axis.title.y = element_blank(),
                           axis.text=element_blank(),
                           axis.ticks = element_blank(),
                           panel.grid = element_blank()) +
  ggtitle("CA Cities Budget")+
  coord_sf()
```

```{r, log cities map}
#log_budget <- log(cities_df_sf_merge$Budget + 1)
cities_df_sf_merge$log_budget <- log(cities_df_sf_merge$Budget + 1)

ggplot() +
  geom_sf(data = CA_state_boundary) +
  geom_sf(data = cities_df_sf_merge, aes(fill= cities_df_sf_merge$log_budget), color = NA) +
  scale_fill_viridis(name = "Log Budget") +
  theme_classic() +
  theme(axis.title.x = element_blank(),
                           axis.title.y = element_blank(),
                           axis.text=element_blank(),
                           axis.ticks = element_blank(),
                           panel.grid = element_blank()) +
  ggtitle("CA Cities Log Budget")+
  coord_sf()
```



